<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcomm Report System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; 
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .preview-img {
            max-width: 64px; 
            max-height: 40px; 
            border-radius: 6px;
            object-fit: cover;
        }
        /* Style for disabled dropdown */
        select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.show {
            max-height: 1000px; 
        }
         /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Styles from Banner Script */
        .banner-table th { position: sticky; top: 0; background-color: #f1f5f9; z-index: 10; }
        .banner-table td, .banner-table th { white-space: nowrap; padding: 12px 16px; vertical-align: top; }
        .banner-table input:not(.active-checkbox), .banner-table select { min-width: 150px; border-radius: 0.375rem; border: 1px solid #cbd5e1; padding: 8px 12px; transition: all 0.2s ease-in-out; }
        .banner-table input.ukuran-input { min-width: 50px; text-align: center; } /* Style tambahan untuk input ukuran */
        .banner-table input:focus, .banner-table select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .banner-table input:disabled:not(.active-checkbox), .banner-table select:disabled { background-color: #f1f5f9; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
            <h1 class="text-3xl font-bold text-center mb-2">Marcomm Report</h1>
            <p class="text-center text-gray-400 mb-8">Please login to continue</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">Username</label>
                    <input type="text" id="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="admin" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="•••••••••" required>
                </div>
                <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition duration-300">Login</button>
                <p id="error-message" class="text-red-500 text-sm mt-4 text-center" style="display: none;">Incorrect username or password.</p>
            </form>
        </div>
    </div>

    <!-- Report Selection Section -->
    <div id="selection-section" class="hidden min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-lg bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-6">Pilih Jenis Report</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button id="select-content-report" class="flex flex-col items-center justify-center p-6 bg-blue-600 text-white rounded-xl shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-[1.02]">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m-9 11h10a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span class="font-semibold text-lg">Report Konten Harian</span>
                </button>
                <button id="select-banner-report" class="flex flex-col items-center justify-center p-6 bg-indigo-600 text-white rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.02]">
                    <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <span class="font-semibold text-lg">Report Manajemen Banner</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 1. Content Report Section -->
    <div id="content-report-section" class="hidden">
        <header class="bg-white shadow-md p-4 sticky top-0 z-20">
            <div class="container mx-auto flex justify-between items-center">
                <h1 id="content-header-title" class="text-2xl font-bold text-gray-800">Daily Content Report</h1>
                <div class="flex items-center space-x-4">
                    <button id="switch-to-selection-content" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Ganti Laporan</button>
                    <button id="logout-button-content" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Combined Sticky Wrapper for Form and Search -->
            <div class="sticky top-16 z-10 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-2">
                    <!-- Search Section -->
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-700">Search Report</h2>
                        <button id="toggle-form-button-content" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1 text-xs">
                            <svg id="toggle-icon-content" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            <span id="toggle-text-content">Add Report</span>
                        </button>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                        <div>
                            <label for="search-tanggal-mulai" class="block mb-1 text-xs font-medium text-gray-700">From Date</label>
                            <input type="date" id="search-tanggal-mulai" class="p-2 border rounded-lg w-full text-xs">
                        </div>
                        <div>
                            <label for="search-tanggal-akhir" class="block mb-1 text-xs font-medium text-gray-700">To Date</label>
                            <input type="date" id="search-tanggal-akhir" class="p-2 border rounded-lg w-full text-xs">
                        </div>
                        <button id="reset-search" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Reset</button>
                    </div>

                    <!-- Collapsible Input Form -->
                    <div id="add-form-container-content" class="collapsible-content">
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <h2 class="text-sm font-semibold text-gray-700 mb-3">Report Input Form</h2>
                            <form id="add-report-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="col-span-1">
                                    <label for="report-tanggal" class="block mb-2 text-sm font-medium text-gray-900">Date</label>
                                    <input type="date" id="report-tanggal" class="p-2 border rounded-lg w-full" required>
                                </div>
                                <div class="col-span-1">
                                    <label for="report-nama" class="block mb-2 text-sm font-medium text-gray-900">Name</label>
                                    <select id="report-nama" class="p-2 border rounded-lg w-full" required>
                                        <option value="">Select Name</option>
                                        <option value="Abil">Abil</option>
                                        <option value="Totok">Totok</option>
                                        <option value="Webi">Webi</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="report-brand" class="block mb-2 text-sm font-medium text-gray-900">Brand</label>
                                     <select id="report-brand" class="p-2 border rounded-lg w-full" required>
                                        <option value="">Select Brand</option>
                                        <option value="wang un">wang un</option>
                                        <option value="kaosedhewe">kaosedhewe</option>
                                        <option value="shift up">shift up</option>
                                    </select>
                                </div>
                                <div id="input-container" class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div id="tiktok-field" class="hidden"><input type="text" id="report-tiktok" placeholder="Tiktok Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="instagram-field" class="hidden"><input type="text" id="report-instagram" placeholder="Instagram Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="mitra-ig-field" class="hidden"><input type="text" id="report-mitra-ig" placeholder="Mitra IG Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="gmb-field" class="hidden"><input type="text" id="report-gmb" placeholder="GMB Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="mitra-sa-field" class="hidden col-span-1 md:col-span-2 lg:col-span-3 flex items-center pt-4">
                                        <input id="report-mitra-sa" type="checkbox" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="report-mitra-sa" class="ml-2 text-sm font-medium text-gray-900">Mitra (SA) Report Done</label>
                                    </div>
                                </div>
                                <div class="col-span-1 md:col-span-2 lg:col-span-3">
                                    <button type="submit" id="submit-report-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Save Report</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Report Table -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg overflow-hidden">
                     <div class="p-6">
                       <h2 class="text-xl font-semibold text-gray-700">Report Details</h2>
                       <p class="text-gray-500 mt-1">The data you input will appear here.</p>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                                <tr>
                                    <th scope="col" class="px-2 py-3">No.</th>
                                    <th scope="col" class="px-2 py-3">Date</th>
                                    <th scope="col" class="px-2 py-3">Name</th>
                                    <th scope="col" class="px-2 py-3">Brand</th>
                                    <th scope="col" class="px-2 py-3">Tiktok</th>
                                    <th scope="col" class="px-2 py-3">Instagram</th>
                                    <th scope="col" class="px-2 py-3">Mitra IG</th>
                                    <th scope="col" class="px-2 py-3">Mitra (SA)</th>
                                    <th scope="col" class="px-2 py-3">GMB</th>
                                    <th scope="col" class="px-2 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="report-body">
                                <!-- Data will be loaded from Firebase here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                         <h2 class="text-xl font-semibold text-gray-700 mb-4">Total Content</h2>
                         <div id="summary-section" class="space-y-3">
                            <div class="flex justify-between items-center text-gray-600"><span>Tiktok</span><span id="total-tiktok" class="font-bold text-gray-800 bg-blue-100 text-blue-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Instagram</span><span id="total-instagram" class="font-bold text-gray-800 bg-pink-100 text-pink-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Mitra IG</span><span id="total-mitra-ig" class="font-bold text-gray-800 bg-purple-100 text-purple-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Mitra (SA)</span><span id="total-mitra-sa" class="font-bold text-gray-800 bg-green-100 text-green-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>GMB</span><span id="total-gmb" class="font-bold text-gray-800 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">0</span></div>
                         </div>
                         <div class="mt-4 pt-4 border-t"><p class="text-sm text-gray-500">Totals will update automatically.</p></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 2. Banner Report Section -->
    <div id="banner-report-section" class="hidden p-4 sm:p-6 md:p-8">
        <header class="bg-white shadow-md p-4 sticky top-0 z-20 mb-6">
            <div class="container mx-auto flex justify-between items-center">
                <h1 id="banner-header-title" class="text-2xl font-bold text-gray-800">Data Manajemen Banner</h1>
                <div class="flex items-center space-x-4">
                    <button id="switch-to-selection-banner" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Ganti Laporan</button>
                    <button id="logout-button-banner" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                </div>
            </div>
        </header>

        <div class="container mx-auto">
            <div class="mb-6 p-4 bg-white rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                <div class="md:col-span-2">
                    <label for="searchGorInput" class="block text-sm font-medium text-gray-700 mb-1">Cari Berdasarkan Nama GOR</label>
                    <div class="flex items-center">
                        <input type="text" id="searchGorInput" placeholder="Ketik nama GOR untuk mencari..." class="w-full">
                    </div>
                </div>
                <div class="text-left md:text-right">
                    <h3 class="text-lg font-semibold text-gray-800">Total Biaya Pemasangan</h3>
                    <p id="totalCost" class="text-2xl font-bold text-indigo-600">Rp 0</p>
                </div>
            </div>
            <div class="mb-6 flex justify-start">
                <button id="addRowBtn" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tambah Data
                </button>
            </div>
            <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                <table class="w-full text-sm text-left text-gray-700 banner-table">
                    <thead class="text-xs text-gray-800 uppercase bg-gray-100">
                        <tr>
                            <th class="px-6 py-3">No.</th>
                            <th class="px-6 py-3">Nama GOR</th>
                            <th class="px-6 py-3">Nama Pengelola</th>
                            <th class="px-6 py-3">No HP/WA</th>
                            <th class="px-6 py-3">Planning</th>
                            <th class="px-6 py-3">Biaya</th>
                            <th class="px-6 py-3">Court</th>
                            <th class="px-6 py-3">Status Kerja Sama</th>
                            <th class="px-6 py-3">Tanggal Kunjungan</th>
                            <th scope="col" class="px-6 py-3">Ukuran Banner</th>
                            <th scope="col" class="px-6 py-3">Foto Venue</th>
                            <th scope="col" class="px-6 py-3">Data Customer</th>
                            <th scope="col" class="px-6 py-3">Status</th>
                            <th scope="col" class="px-6 py-3">Payment</th>
                            <th scope="col" class="px-6 py-3">Durasi Pasang</th>
                            <th scope="col" class="px-6 py-3">Tanggal Pasang</th>
                            <th scope="col" class="px-6 py-3">Tanggal Selesai</th>
                            <th scope="col" class="px-6 py-3">Foto Banner Terpasang</th>
                            <th scope="col" class="px-6 py-3">Aksi</th>
                            <th scope="col" class="px-6 py-3">Active</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>
            
            <!-- Modals for GOR Management (Banner Report) -->
            <div id="optionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><h3 id="modalTitle" class="text-lg text-center font-medium text-gray-900">Tambah Pilihan Baru</h3><input type="text" id="newOptionInput" class="w-full mt-2" placeholder="Ketik pilihan baru..."><div class="items-center px-4 py-3 text-right"><button id="closeModalBtn" class="px-4 py-2 bg-gray-200 rounded-md">Batal</button><button id="saveOptionBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md ml-2">Simpan</button></div></div></div>
            <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><h3 class="text-lg font-medium text-gray-900">Konfirmasi Hapus</h3><p class="mt-2 text-sm text-gray-600">Apakah Anda yakin ingin menghapus data ini?</p><div class="items-center px-4 py-3 text-right"><button id="cancelDeleteBtnGor" class="px-4 py-2 bg-gray-200 rounded-md">Batal</button><button id="confirmDeleteBtnGor" class="px-4 py-2 bg-red-600 text-white rounded-md ml-2">Ya, Hapus</button></div></div></div>
            <div id="extendModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><h3 class="text-lg font-medium text-gray-900">Perpanjang Kontrak</h3><div class="mt-4 space-y-4"><div><label class="block text-sm font-medium">Durasi Perpanjangan</label><div class="flex items-center gap-2 mt-1"><input type="number" id="extendDuration" class="w-20" min="1" max="11" value="1"><select id="extendUnit"><option value="Bulan">Bulan</option><option value="Tahun">Tahun</option></select></div></div><div><label class="block text-sm font-medium">Biaya Perpanjangan</label><input type="number" id="extendCost" class="w-full mt-1" placeholder="Masukkan nominal perpanjangan"></div></div><div class="items-center px-4 py-3 text-right"><button id="cancelExtendBtn" class="px-4 py-2 bg-gray-200 rounded-md">Batal</button><button id="saveExtendBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md ml-2">Simpan</button></div></div></div>
            
            <!-- NEW Modal for Link Management -->
            <div id="linkModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
                <div class="relative top-1/4 mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white">
                    <h3 id="linkModalTitle" class="text-xl font-medium text-gray-900 mb-4">Kelola Link</h3>
                    <div id="linkInputsContainer" class="space-y-3 mb-4 max-h-64 overflow-y-auto custom-scrollbar">
                        <!-- Dynamic link inputs will be inserted here -->
                    </div>
                    <button id="addLinkBtn" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition duration-150">
                        + Tambah Link
                    </button>
                    <div class="items-center px-4 py-3 text-right mt-4 border-t pt-4">
                        <button id="closeLinkModalBtn" class="px-4 py-2 bg-gray-300 rounded-md">Batal</button>
                        <button id="saveLinksBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md ml-2">Simpan Link</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Modals for Content Report -->
    <div id="delete-modal" class="fixed inset-0 z-30 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Delete Confirmation</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this report? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
            </div>
        </div>
    </div>
    
     <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p id="loading-text" class="text-gray-700">Saving data...</p>
        </div>
    </div>

    <script type="module">
        // Import functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDgkGmmXLwESu2zODxX3eb5_Eu4aSK0HpQ",
            authDomain: "reportmarcomm-d1ef9.firebaseapp.com",
            projectId: "reportmarcomm-d1ef9",
            storageBucket: "reportmarcomm-d1ef9.firebasestorage.app", 
            messagingSenderId: "510927575797",
            appId: "1:510927575797:web:0397850bcbdcbb078003bc", 
            measurementId: "G-W07G2HHF84" 
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- Element References ---
        const loginSection = document.getElementById('login-section');
        const selectionSection = document.getElementById('selection-section'); 
        const contentReportSection = document.getElementById('content-report-section'); 
        const bannerReportSection = document.getElementById('banner-report-section'); 
        const selectContentBtn = document.getElementById('select-content-report'); 
        const selectBannerBtn = document.getElementById('select-banner-report'); 
        const switchToSelectionContent = document.getElementById('switch-to-selection-content');
        const switchToSelectionBanner = document.getElementById('switch-to-selection-banner');

        // Content Report Elements
        const loginForm = document.getElementById('login-form');
        const logoutButtonContent = document.getElementById('logout-button-content');
        const errorMessage = document.getElementById('error-message');
        const addReportForm = document.getElementById('add-report-form');
        const reportBody = document.getElementById('report-body');
        const namaSelect = document.getElementById('report-nama');
        const brandSelect = document.getElementById('report-brand');
        const searchTanggalMulai = document.getElementById('search-tanggal-mulai');
        const searchTanggalAkhir = document.getElementById('search-tanggal-akhir');
        const resetSearchButton = document.getElementById('reset-search');
        
        const toggleFormButton = document.getElementById('toggle-form-button-content'); 
        const addFormContainer = document.getElementById('add-form-container-content'); 
        const toggleText = document.getElementById('toggle-text-content');
        const toggleIcon = document.getElementById('toggle-icon-content');
        
        const deleteModal = document.getElementById('delete-modal');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const logoutButtonBanner = document.getElementById('logout-button-banner'); 
        
        let rowToDelete = null;
        let reportsDataCache = []; 

        // --- Banner Report References & Variables ---
        const bannerCollection = collection(db, "banners"); 
        let bannerDataCache = []; 
        let bannerSnapshotUnsubscribe = null; 
        let isBannerScriptLoaded = false; 

        // Banner Elements
        const addRowBtn = document.getElementById('addRowBtn');
        const tableBodyGor = document.getElementById('data-table-body');
        const totalCostEl = document.getElementById('totalCost');
        const searchGorInput = document.getElementById('searchGorInput');
        const optionModal = document.getElementById('optionModal');
        const confirmModalGor = document.getElementById('confirmModal');
        const extendModal = document.getElementById('extendModal');
        const cancelDeleteBtnGor = document.getElementById('cancelDeleteBtnGor');
        const confirmDeleteBtnGor = document.getElementById('confirmDeleteBtnGor');
        const saveOptionBtn = document.getElementById('saveOptionBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelExtendBtn = document.getElementById('cancelExtendBtn');
        const saveExtendBtn = document.getElementById('saveExtendBtn');

        // NEW Link Modal Elements
        const linkModal = document.getElementById('linkModal');
        const linkModalTitle = document.getElementById('linkModalTitle');
        const linkInputsContainer = document.getElementById('linkInputsContainer');
        const addLinkBtn = document.getElementById('addLinkBtn');
        const closeLinkModalBtn = document.getElementById('closeLinkModalBtn');
        const saveLinksBtn = document.getElementById('saveLinksBtn');
        let currentLinkFieldName = null; // Menyimpan nama field yang sedang diedit (e.g., 'fotoVenueLinks')
        let currentLinkRowId = null;     // Menyimpan ID baris yang sedang diedit

        let rowToDeleteGor = null, rowToExtend = null, currentSelect, currentOptionsArray, currentSelectClass;
        let planningOptions = ['Banner', 'Placing Brosur'];
        let statusOptions = ['Proses Cetak', 'Revisi', 'Proses Design', 'Bisa di FU', 'Pengajuan Finance (Belum ACC)', 'Pengajuan Finance (Done)'];

        const fields = {
            tiktok: document.getElementById('tiktok-field'),
            instagram: document.getElementById('instagram-field'),
            mitraIg: document.getElementById('mitra-ig-field'),
            mitraSa: document.getElementById('mitra-sa-field'),
            gmb: document.getElementById('gmb-field')
        };

        // --- Helper Function to manage display ---
        function setReportView(viewId) {
            contentReportSection.classList.add('hidden');
            bannerReportSection.classList.add('hidden');
            selectionSection.classList.add('hidden');
            loginSection.classList.add('hidden'); 

            if (viewId === 'content') {
                bannerSnapshotUnsubscribe && bannerSnapshotUnsubscribe(); 
                contentReportSection.classList.remove('hidden');
            } else if (viewId === 'banner') {
                contentSnapshotUnsubscribe && contentSnapshotUnsubscribe(); 
                bannerReportSection.classList.remove('hidden');
            } else if (viewId === 'selection') {
                 bannerSnapshotUnsubscribe && bannerSnapshotUnsubscribe(); 
                 contentSnapshotUnsubscribe && contentSnapshotUnsubscribe(); 
                 selectionSection.classList.remove('hidden');
            } else if (viewId === 'login') {
                 bannerSnapshotUnsubscribe && bannerSnapshotUnsubscribe(); 
                 contentSnapshotUnsubscribe && contentSnapshotUnsubscribe(); 
                 loginSection.classList.remove('hidden');
            }
        }

        // --- Login Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'admin' && password === 'marcomm') {
                setReportView('selection'); 
                errorMessage.style.display = 'none';
            } else {
                errorMessage.style.display = 'block';
            }
        });

        // --- Logout Logic ---
        function logout() {
            setReportView('login');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        logoutButtonContent.addEventListener('click', logout);
        logoutButtonBanner.addEventListener('click', logout); 

        // --- Report Selection Logic ---
        selectContentBtn.addEventListener('click', () => {
            setReportView('content');
            document.getElementById('report-tanggal').valueAsDate = new Date();
            loadReports(); 
        });

        selectBannerBtn.addEventListener('click', () => {
            setReportView('banner');
            if (!isBannerScriptLoaded) {
                initializeBannerReportListeners(); 
                isBannerScriptLoaded = true;
            }
            loadBannerReports(); 
        });

        // --- Switch Report Logic ---
        switchToSelectionContent.addEventListener('click', () => {
            setReportView('selection');
        });

        switchToSelectionBanner.addEventListener('click', () => {
            setReportView('selection');
        });


        // ==========================================================
        //         1. CONTENT REPORT (Firebase) LOGIC
        // ==========================================================
        let contentSnapshotUnsubscribe = null; 

        // Logic Toggle Form Content
        toggleFormButton.addEventListener('click', () => {
            const isShown = addFormContainer.classList.toggle('show');
            if (isShown) {
                toggleText.textContent = 'Close Form';
                toggleIcon.style.transform = 'rotate(45deg)';
            } else {
                toggleText.textContent = 'Add Report';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        });

        function loadReports() {
            if (contentSnapshotUnsubscribe) contentSnapshotUnsubscribe();
            const q = query(collection(db, "reports"), orderBy("tanggal", "desc"));
            contentSnapshotUnsubscribe = onSnapshot(q, (querySnapshot) => {
                reportsDataCache = [];
                querySnapshot.forEach((doc) => {
                    reportsDataCache.push({ id: doc.id, ...doc.data() });
                });
                renderTable(); 
            });
        }
        // --- (Sisanya dari Report Konten sama seperti sebelumnya) ---

        // --- Render Table from Cache (Content Report) ---
        function renderTable() {
            const startDate = searchTanggalMulai.value;
            const endDate = searchTanggalAkhir.value;
            
            const filteredData = reportsDataCache.filter(report => {
                const rowDate = report.tanggal;
                const isAfterStart = startDate ? rowDate >= startDate : true;
                const isBeforeEnd = endDate ? rowDate <= endDate : true;
                return isAfterStart && isBeforeEnd;
            });

            reportBody.innerHTML = '';
            filteredData.forEach((report, index) => {
                const newRow = document.createElement('tr');
                newRow.className = 'bg-white border-b hover:bg-gray-50';
                newRow.dataset.id = report.id;

                const mitraSaContent = report.mitraSaDone 
                    ? `<svg class="w-5 h-5 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                    : '-';
                
                newRow.innerHTML = `
                    <td class="px-2 py-4">${index + 1}</td>
                    <td class="px-2 py-4">${report.tanggal}</td>
                    <td class="px-2 py-4 font-medium text-gray-900">${report.nama}</td>
                    <td class="px-2 py-4">${report.brand}</td>
                    <td class="px-2 py-4">${(report.tiktok && report.tiktok.trim() !== '-') ? `<a href="${report.tiktok}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">${(report.instagram && report.instagram.trim() !== '-') ? `<a href="${report.instagram}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">${(report.mitraIg && report.mitraIg.trim() !== '-') ? `<a href="${report.mitraIg}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4 text-center">${mitraSaContent}</td>
                    <td class="px-2 py-4">${(report.gmb && report.gmb.trim() !== '-') ? `<a href="${report.gmb}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md">Delete</button>
                    </td>
                `;
                reportBody.appendChild(newRow);
            });
            updateTotals();
        }

        // --- (Sisanya dari Report Konten sama seperti sebelumnya) ---
        reportBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                rowToDelete = e.target.closest('tr'); 
                deleteModal.classList.remove('hidden'); 
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            rowToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (rowToDelete) {
                loadingText.textContent = "Deleting data...";
                loadingModal.classList.remove('hidden');
                const docId = rowToDelete.dataset.id;
                
                try {
                    await deleteDoc(doc(db, "reports", docId));
                } catch(error) {
                    console.error("Error removing document: ", error);
                    alert("Failed to delete report.");
                } finally {
                    rowToDelete = null;
                    deleteModal.classList.add('hidden');
                    loadingModal.classList.add('hidden');
                }
            }
        });

        searchTanggalMulai.addEventListener('input', renderTable);
        searchTanggalAkhir.addEventListener('input', renderTable);
        resetSearchButton.addEventListener('click', () => {
            searchTanggalMulai.value = '';
            searchTanggalAkhir.value = '';
            renderTable();
        });

        function updateTotals() {
            const rows = reportBody.getElementsByTagName('tr');
            let counts = { tiktok: 0, instagram: 0, mitraIg: 0, mitraSa: 0, gmb: 0 };
            for (let row of rows) {
                const cells = row.cells;
                if (cells[4].querySelector('a')) counts.tiktok++;
                if (cells[5].querySelector('a')) counts.instagram++;
                if (cells[6].querySelector('a')) counts.mitraIg++;
                if (cells[7].querySelector('svg')) counts.mitraSa++;
                if (cells[8].querySelector('a')) counts.gmb++;
            }
            document.getElementById('total-tiktok').textContent = counts.tiktok;
            document.getElementById('total-instagram').textContent = counts.instagram;
            document.getElementById('total-mitra-ig').textContent = counts.mitraIg;
            document.getElementById('total-mitra-sa').textContent = counts.mitraSa;
            document.getElementById('total-gmb').textContent = counts.gmb;
        }

        addReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingText.textContent = "Saving data...";
            loadingModal.classList.remove('hidden');

            try {
                const reportData = {
                    tanggal: document.getElementById('report-tanggal').value,
                    nama: namaSelect.value,
                    brand: brandSelect.value,
                    tiktok: document.getElementById('report-tiktok').value,
                    instagram: document.getElementById('report-instagram').value,
                    mitraIg: document.getElementById('report-mitra-ig').value,
                    gmb: document.getElementById('report-gmb').value,
                    mitraSaDone: document.getElementById('report-mitra-sa').checked,
                    createdAt: new Date()
                };

                if (!reportData.tanggal || !reportData.nama || !reportData.brand) {
                    alert('Please complete Date, Name, and Brand.');
                    return;
                }
                
                await addDoc(collection(db, "reports"), reportData);
                addReportForm.reset();
                namaSelect.dispatchEvent(new Event('change'));
                document.getElementById('report-tanggal').valueAsDate = new Date();
            } catch (error) {
                console.error("Error during report submission: ", error);
                alert("Failed to save report. Please check your connection and try again.");
            } finally {
                loadingModal.classList.add('hidden');
            }
        });
        
        namaSelect.addEventListener('change', () => {
            const selectedName = namaSelect.value;
            Object.values(fields).forEach(field => field.classList.add('hidden'));
            brandSelect.disabled = false;
            switch(selectedName) {
                case 'Abil':
                    brandSelect.value = 'wang un';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.mitraIg.classList.remove('hidden');
                    break;
                case 'Totok':
                    brandSelect.value = 'kaosedhewe';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.mitraSa.classList.remove('hidden');
                    break;
                case 'Webi':
                    brandSelect.value = 'shift up';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.gmb.classList.remove('hidden');
                    break;
                default:
                    brandSelect.value = '';
                    brandSelect.disabled = false;
                    break;
            }
        });


        // ==========================================================
        //         2. BANNER REPORT (Firebase) LOGIC
        // ==========================================================
        
        const LINK_FIELD_MAP = {
            'fotoVenueLinks': { title: 'Foto Venue', colIndex: 10 },
            'dataCustomerLinks': { title: 'Data Customer', colIndex: 11 },
            'fotoBannerLinks': { title: 'Foto Banner Terpasang', colIndex: 17 }
        };
        const URL_PLACEHOLDER = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUAAAAEAAAABACAYAAADmPMiNAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=";


        // FUNGSI INI DIUBAH untuk mengembalikan input type="number" desimal
        function createNumberInput(defaultValue = 1.0) { 
            // Tambahkan step="0.1" untuk memungkinkan input desimal, dan min="0.1"
            return `<input type="number" class="w-20 ukuran-input" min="0.1" step="0.1" value="${defaultValue}">`; 
        }
        
        function createCourtSelect(max, defaultValue = 1) {
             return `<select class="w-20">${Array.from({length: max}, (_, i) => `<option value="${i+1}" ${i+1 === defaultValue ? 'selected' : ''}>${i+1}</option>`).join('')}</select>`;
        }
        
        function createDynamicSelect(options, sClass, selectedValue = '') { 
            return `<select class="${sClass}"><option value="">-- Pilih --</option>${options.map(o => `<option value="${o}" ${o === selectedValue ? 'selected' : ''}>${o}</option>`).join('')}<option value="add_new" class="text-indigo-600 font-semibold">-- Tambah Pilihan Baru --</option></select>`; 
        }

        // FUNGSI INI DIUBAH TOTAL UNTUK MEMENUHI PERMINTAAN USER
        function createLinkButtonCell(fieldKey, links, isEditable) {
            const count = (links && links.length) || 0;
            const buttonText = `Kelola (${count})`; 
            const buttonClass = count > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-400 hover:bg-gray-500';

            if (isEditable) {
                // Mode Edit: Tampilkan tombol untuk mengelola daftar link
                return `<td class="px-6 py-4 text-center link-cell" data-field="${fieldKey}">
                            <button type="button" class="manage-links-btn ${buttonClass} text-white text-xs py-1 px-2 rounded-md transition duration-150" data-field="${fieldKey}">${buttonText}</button>
                        </td>`;
            } else {
                // Mode View (User Request): Tampilkan dropdown untuk memilih dan melihat link
                if (count === 0) {
                    return `<td class="px-6 py-4 text-center link-cell" data-field="${fieldKey}">
                                <span class="text-gray-500 text-xs">0 Link</span>
                            </td>`;
                }
                
                const optionsHTML = links.map((link, index) => 
                    `<option value="${link}">Link ${index + 1}</option>`
                ).join('');
                
                // Tambahkan kelas link-viewer-select dan w-full agar dapat dipilih
                return `<td class="px-6 py-4 text-center link-cell" data-field="${fieldKey}">
                            <select class="link-viewer-select w-full text-xs" data-field="${fieldKey}">
                                <option value="">-- Pilih & Lihat (${count}) --</option>
                                ${optionsHTML}
                            </select>
                        </td>`;
            }
        }

        // FUNGSI INI DIUBAH UNTUK MENGATUR VISIBILITAS SELECT BARU
        function toggleRowInputs(row, enable) {
            row.querySelectorAll('input, select').forEach(input => {
                // Kecualikan .link-viewer-select dari disabling standar agar bisa digunakan untuk melihat link
                if (!input.classList.contains('active-checkbox') && !input.classList.contains('link-viewer-select')) {
                    input.disabled = !enable;
                }
            });

            // Toggle visibility untuk elemen manajemen link
            row.querySelectorAll('.manage-links-btn').forEach(btn => {
                btn.classList.toggle('hidden', !enable); // Tampilkan tombol kelola hanya saat mengedit
            });
            row.querySelectorAll('.link-viewer-select').forEach(select => {
                select.classList.toggle('hidden', enable); // Sembunyikan dropdown saat mengedit
                select.disabled = enable; // Nonaktifkan juga saat mengedit
            });
            row.querySelectorAll('.link-cell > span').forEach(span => {
                span.classList.toggle('hidden', enable); // Sembunyikan "0 Link" span saat mengedit
            });
        }
        
        function renumberRows() { Array.from(tableBodyGor.rows).filter(r => r.style.display !== 'none').forEach((row, i) => row.cells[0].textContent = i + 1); }

        function updateTotalCost() {
            let total = Array.from(tableBodyGor.querySelectorAll('.biaya-input:disabled')).reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            totalCostEl.textContent = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(total);
        }
        
        // Fungsi untuk menggenerasi input link di modal
        function generateLinkInput(link = '') {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center space-x-2 link-input-item';
            wrapper.innerHTML = `
                <input type="url" value="${link}" placeholder="Masukkan Link/URL" class="w-full p-2 border rounded text-sm link-input-field">
                <button type="button" class="px-2 py-1 bg-red-500 text-white rounded text-xs delete-link-btn hover:bg-red-600 transition duration-150">Hapus</button>
                <a href="${link}" target="_blank" rel="noopener noreferrer" class="px-2 py-1 bg-gray-500 text-white rounded text-xs view-link-btn hover:bg-gray-600 transition duration-150" style="display: ${link ? 'inline-block' : 'none'};">Lihat</a>
            `;
            
            // Event listener untuk tombol hapus
            wrapper.querySelector('.delete-link-btn').addEventListener('click', () => wrapper.remove());
            
            // Event listener untuk update tautan "Lihat" saat input berubah
            wrapper.querySelector('.link-input-field').addEventListener('input', (e) => {
                const link = e.target.value;
                const viewBtn = wrapper.querySelector('.view-link-btn');
                viewBtn.href = link;
                viewBtn.style.display = link ? 'inline-block' : 'none';
            });
            
            linkInputsContainer.appendChild(wrapper);
        }

        async function saveBannerRowToFirebase(row, docId = null) {
            loadingText.textContent = docId ? "Updating banner data..." : "Saving new banner data...";
            loadingModal.classList.remove('hidden');

            try {
                // DIPERBAIKI: Ambil elemen durasi menggunakan class yang tepat
                const durasiElement = row.querySelector('.durasi-cell .durasi-input'); // Harus berupa input type="number"
                const unitElement = row.querySelector('.durasi-cell .durasi-unit'); // Harus berupa select
                
                // Ambil nilai dari input type="number" untuk Ukuran Banner
                const ukuranXInput = row.cells[9].querySelector('.ukuran-x-input');
                const ukuranYInput = row.cells[9].querySelector('.ukuran-y-input');

                if (!durasiElement || !unitElement) {
                     // Ini seharusnya tidak terjadi lagi dengan perbaikan di renderBannerTable/addRow
                     throw new Error("Missing Durasi Input/Select element in the row. Cannot save.");
                }
                
                const data = {
                    gorName: row.cells[1].querySelector('input').value || '-',
                    pengelola: row.cells[2].querySelector('input').value || '-',
                    noHp: row.cells[3].querySelector('input').value || '-',
                    planning: row.cells[4].querySelector('select').value || '-',
                    biaya: parseFloat(row.cells[5].querySelector('input').value) || 0,
                    court: parseInt(row.cells[6].querySelector('select').value) || 0,
                    statusKerjaSama: row.cells[7].querySelector('select').value || '-',
                    tglKunjungan: row.cells[8].querySelector('input').value || '-',
                    // UBAH: Ambil dari input number dan parse sebagai float (desimal support)
                    ukuranX: parseFloat(ukuranXInput.value) || 0.1,
                    ukuranY: parseFloat(ukuranYInput.value) || 0.1,
                    status: row.cells[12].querySelector('select').value || '-',
                    payment: row.cells[13].querySelector('input').value || '-',
                    // DIPERBAIKI: Durasi diambil dari input dan harus integer (bulan/tahun)
                    durasi: parseInt(durasiElement.value) || 0,
                    durasiUnit: unitElement.value || 'Bulan',
                    tglPasang: row.cells[15].querySelector('input').value || '-',
                    tglSelesai: row.cells[16].querySelector('input').value || '-',
                    isActive: true, 
                    // NEW: Link fields
                    fotoVenueLinks: row.dataset.fotoVenueLinks ? JSON.parse(row.dataset.fotoVenueLinks) : [],
                    dataCustomerLinks: row.dataset.dataCustomerLinks ? JSON.parse(row.dataset.dataCustomerLinks) : [],
                    fotoBannerLinks: row.dataset.fotoBannerLinks ? JSON.parse(row.dataset.fotoBannerLinks) : [],
                    createdAt: new Date()
                };

                if (!data.gorName || data.gorName === '-' || data.biaya < 0) {
                     throw new Error("Data minimal (Nama GOR dan Biaya) harus diisi dengan benar.");
                }

                if (docId) {
                    await setDoc(doc(db, "banners", docId), data, { merge: true });
                } else {
                    await addDoc(bannerCollection, data);
                }
                
            } catch (error) {
                console.error("FIREBASE SAVE ERROR:", error); 
                alert("Gagal menyimpan data banner. Pastikan: 1. Nama GOR terisi. 2. Biaya adalah angka non-negatif. 3. Aturan Keamanan Firebase mengizinkan penulisan (allow write: if true). Error detail: " + error.message);
            } finally {
                loadingModal.classList.add('hidden');
            }
        }

        async function deleteBannerRowFromFirebase(docId) {
            loadingText.textContent = "Deleting banner data...";
            loadingModal.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, "banners", docId));
            } catch (error) {
                console.error("Error deleting banner: ", error);
                alert("Gagal menghapus data banner.");
            } finally {
                rowToDeleteGor = null;
                confirmModalGor.style.display = 'none';
                loadingModal.classList.add('hidden');
            }
        }

        function renderBannerTable() {
            const term = searchGorInput.value.toLowerCase();
            const filteredData = bannerDataCache.filter(data => 
                (data.gorName || '').toLowerCase().includes(term)
            );

            tableBodyGor.innerHTML = '';
            filteredData.forEach((data, index) => {
                const newRow = document.createElement('tr');
                newRow.className = 'bg-white border-b hover:bg-gray-50';
                newRow.dataset.id = data.id;
                
                // Simpan data links di dataset row untuk akses mudah saat mengedit
                newRow.dataset.fotoVenueLinks = JSON.stringify(data.fotoVenueLinks || []);
                newRow.dataset.dataCustomerLinks = JSON.stringify(data.dataCustomerLinks || []);
                newRow.dataset.fotoBannerLinks = JSON.stringify(data.fotoBannerLinks || []);


                // DIPERBAIKI: Gunakan input number eksplisit untuk Durasi Pasang
                const durasiInputHTML = `<input type="number" class="w-20 durasi-input" min="1" max="11" value="${data.durasi || 1}">`;
                const durasiUnitHTML = `<select class="durasi-unit"><option value="Bulan" ${data.durasiUnit === 'Bulan' ? 'selected' : ''}>Bulan</option><option value="Tahun" ${data.durasiUnit === 'Tahun' ? 'selected' : ''}>Tahun</option></select>`;
                const durasiCellHTML = `<div class="flex items-center gap-2">${durasiInputHTML}${durasiUnitHTML}</div>`;
                
                // Ukuran Banner: Tetap menggunakan input number desimal (dari langkah sebelumnya)
                const ukuranX = data.ukuranX || 1.0;
                const ukuranY = data.ukuranY || 1.0;
                const ukuranCellHTML = `<div class="flex items-center gap-2">
                                            ${createNumberInput(ukuranX).replace('class="w-20 ukuran-input"', 'class="w-20 ukuran-input ukuran-x-input"')} M x 
                                            ${createNumberInput(ukuranY).replace('class="w-20 ukuran-input"', 'class="w-20 ukuran-input ukuran-y-input"')} M
                                        </div>`;
                
                const isRowEnabled = false; // Mode view by default
                
                // NEW: Gunakan fungsi baru untuk membuat tombol link
                const fotoVenueCell = createLinkButtonCell('fotoVenueLinks', data.fotoVenueLinks, isRowEnabled);
                const dataCustomerCell = createLinkButtonCell('dataCustomerLinks', data.dataCustomerLinks, isRowEnabled);
                const fotoBannerCell = createLinkButtonCell('fotoBannerLinks', data.fotoBannerLinks, isRowEnabled);
                
                newRow.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4"><input type="text" placeholder="Nama GOR" class="gor-name-input" value="${data.gorName || ''}"></td>
                    <td class="px-6 py-4"><input type="text" placeholder="Nama Pengelola" value="${data.pengelola || ''}"></td>
                    <td class="px-6 py-4"><input type="tel" placeholder="08..." value="${data.noHp || ''}"></td>
                    <td class="px-6 py-4">${createDynamicSelect(planningOptions, 'planning-select', data.planning)}</td>
                    <td class="px-6 py-4"><input type="number" placeholder="0" min="0" class="biaya-input" value="${data.biaya || 0}"></td>
                    <td class="px-6 py-4">${createCourtSelect(100, data.court || 1)}</td>
                    <td class="px-6 py-4"><select><option value="">-- Pilih --</option><option value="Deal" ${data.statusKerjaSama === 'Deal' ? 'selected' : ''}>Deal</option><option value="Proses" ${data.statusKerjaSama === 'Proses' ? 'selected' : ''}>Proses</option></select></td>
                    <td class="px-6 py-4"><input type="date" value="${data.tglKunjungan || ''}"></td>
                    <td class="px-6 py-4">${ukuranCellHTML}</td>
                    ${fotoVenueCell}
                    ${dataCustomerCell}
                    <td class="px-6 py-4">${createDynamicSelect(statusOptions, 'status-select', data.status)}</td>
                    <td class="px-6 py-4"><input type="text" placeholder="Detail Payment" value="${data.payment || ''}"></td>
                    <td class="px-6 py-4 durasi-cell">${durasiCellHTML}</td>
                    <td class="px-6 py-4"><input type="date" value="${data.tglPasang || ''}"></td>
                    <td class="px-6 py-4"><input type="date" value="${data.tglSelesai || ''}"></td>
                    ${fotoBannerCell}
                    <td class="px-6 py-4 action-cell">
                        <button class="edit-btn px-3 py-1 bg-yellow-400 text-white rounded hover:bg-yellow-500 text-xs">Edit</button>
                        <button class="delete-btn ml-1 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">Hapus</button>
                        <button class="extend-btn ml-1 px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs">Perpanjang</button>
                    </td>
                    <td class="px-6 py-4 text-center"><span class="text-green-600 font-bold">✓</span></td>
                `;
                toggleRowInputs(newRow, false); 
                tableBodyGor.appendChild(newRow);
            });
            updateTotalCost();
            renumberRows();
        }

        function loadBannerReports() {
            if (bannerSnapshotUnsubscribe) {
                bannerSnapshotUnsubscribe();
            }
            
            const q = query(bannerCollection, orderBy("gorName", "asc"));
            
            bannerSnapshotUnsubscribe = onSnapshot(q, (querySnapshot) => {
                bannerDataCache = [];
                querySnapshot.forEach((doc) => {
                    // Tambahkan data link ke cache
                    const data = doc.data();
                    data.fotoVenueLinks = data.fotoVenueLinks || [];
                    data.dataCustomerLinks = data.dataCustomerLinks || [];
                    data.fotoBannerLinks = data.fotoBannerLinks || [];

                    bannerDataCache.push({ id: doc.id, ...data });
                });
                renderBannerTable();
            });
        }
        
        function addRow() {
            const newRow = tableBodyGor.insertRow(0); 
            newRow.className = 'bg-white border-b hover:bg-gray-50';
            
            // Set dataset untuk baris baru (semua link kosong)
            newRow.dataset.fotoVenueLinks = JSON.stringify([]);
            newRow.dataset.dataCustomerLinks = JSON.stringify([]);
            newRow.dataset.fotoBannerLinks = JSON.stringify([]);
            
            const isRowEnabled = true;
            
            // DIPERBAIKI: Gunakan input number eksplisit untuk Durasi Pasang
            const durasiInputHTML = `<input type="number" class="w-20 durasi-input" min="1" max="11" value="1">`;
            const durasiUnitHTML = `<select class="durasi-unit"><option value="Bulan">Bulan</option><option value="Tahun">Tahun</option></select>`;
            const durasiCellHTML = `<div class="flex items-center gap-2">${durasiInputHTML}${durasiUnitHTML}</div>`;
            
            // Ukuran Banner: Tetap menggunakan input number desimal
            const ukuranCellHTML = `<div class="flex items-center gap-2">
                                        ${createNumberInput(1.0).replace('class="w-20 ukuran-input"', 'class="w-20 ukuran-input ukuran-x-input"')} M x 
                                        ${createNumberInput(1.0).replace('class="w-20 ukuran-input"', 'class="w-20 ukuran-input ukuran-y-input"')} M
                                    </div>`;

            // NEW: Buat sel tombol link (isRowEnabled = true)
            const fotoVenueCell = createLinkButtonCell('fotoVenueLinks', [], isRowEnabled);
            const dataCustomerCell = createLinkButtonCell('dataCustomerLinks', [], isRowEnabled);
            const fotoBannerCell = createLinkButtonCell('fotoBannerLinks', [], isRowEnabled);

            newRow.innerHTML = `
                <td class="px-6 py-4 font-medium text-gray-900"></td>
                <td class="px-6 py-4"><input type="text" placeholder="Nama GOR" class="gor-name-input"></td>
                <td class="px-6 py-4"><input type="text" placeholder="Nama Pengelola"></td>
                <td class="px-6 py-4"><input type="tel" placeholder="08..."></td>
                <td class="px-6 py-4">${createDynamicSelect(planningOptions, 'planning-select')}</td>
                <td class="px-6 py-4"><input type="number" placeholder="0" min="0" class="biaya-input"></td>
                <td class="px-6 py-4">${createCourtSelect(100, 1)}</td>
                <td class="px-6 py-4"><select><option value="">-- Pilih --</option><option value="Deal">Deal</option><option value="Proses">Proses</option></select></td>
                <td class="px-6 py-4"><input type="date"></td>
                <td class="px-6 py-4">${ukuranCellHTML}</td>
                ${fotoVenueCell} 
                ${dataCustomerCell}
                <td class="px-6 py-4">${createDynamicSelect(statusOptions, 'status-select')}</td>
                <td class="px-6 py-4"><input type="text" placeholder="Detail Payment"></td>
                <td class="px-6 py-4 durasi-cell">${durasiCellHTML}</td>
                <td class="px-6 py-4"><input type="date"></td>
                <td class="px-6 py-4"><input type="date"></td>
                ${fotoBannerCell}
                <td class="px-6 py-4 action-cell">
                    <button class="save-new-btn px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-xs">Simpan</button>
                    <button class="delete-new-btn ml-1 px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs">Batal</button>
                </td>
                <td class="px-6 py-4 text-center"><input type="checkbox" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 active-checkbox" disabled></td>
            `;
            toggleRowInputs(newRow, true); 
            renumberRows();
        }

        // --- Event Listeners Initialization for Banner Report ---
        function initializeBannerReportListeners() {
            addRowBtn.addEventListener('click', addRow);
            searchGorInput.addEventListener('input', renderBannerTable);
            
            // Listener untuk Dropdown Link Viewer (Mode View/Non-editable)
            tableBodyGor.addEventListener('change', function(e) {
                if (e.target.classList.contains('link-viewer-select')) {
                    const selectedLink = e.target.value;
                    if (selectedLink) {
                        window.open(selectedLink, '_blank');
                        // Reset select kembali ke placeholder setelah link dibuka
                        e.target.value = '';
                    }
                }
            });

            // Modal Listeners
            confirmDeleteBtnGor.addEventListener('click', () => {
                if(rowToDeleteGor) { 
                    const docId = rowToDeleteGor.dataset.id;
                    deleteBannerRowFromFirebase(docId);
                }
            });
            cancelDeleteBtnGor.addEventListener('click', () => {
                confirmModalGor.style.display = 'none'; 
                rowToDeleteGor = null;
            });
            [closeModalBtn, saveOptionBtn].forEach(btn => btn.addEventListener('click', () => {
                if (btn.id === 'saveOptionBtn') {
                    const newOptionText = document.getElementById('newOptionInput').value.trim();
                    if (newOptionText && !currentOptionsArray.includes(newOptionText)) {
                        currentOptionsArray.push(newOptionText);
                        document.querySelectorAll(`.${currentSelectClass}`).forEach(select => {
                            const newOption = new Option(newOptionText, newOptionText);
                            select.insertBefore(newOption, select.querySelector('option[value="add_new"]'));
                        });
                        if (currentSelect) currentSelect.value = newOptionText;
                        document.getElementById('newOptionInput').value = '';
                    } else if (newOptionText) {
                        alert('Pilihan sudah ada.');
                    } else {
                        alert('Pilihan tidak boleh kosong.');
                    }
                }
                optionModal.style.display = 'none';
            }));
            
            // Listener untuk Modal Perpanjang Kontrak
            saveExtendBtn.addEventListener('click', () => {
                if(rowToExtend) {
                    const extendCost = parseFloat(document.getElementById('extendCost').value) || 0;
                    const currentCostInput = rowToExtend.querySelector('.biaya-input');
                    
                    // Simpan data di Firebase
                    saveBannerRowToFirebase(rowToExtend, rowToExtend.dataset.id);
                }
                extendModal.style.display = 'none'; 
                rowToExtend = null;
            });

            cancelExtendBtn.addEventListener('click', () => {
                extendModal.style.display = 'none'; 
                rowToExtend = null;
            });

            // Listener Modal Link
            addLinkBtn.addEventListener('click', () => generateLinkInput());
            
            closeLinkModalBtn.addEventListener('click', () => linkModal.style.display = 'none');
            
            saveLinksBtn.addEventListener('click', async () => {
                const row = document.querySelector(`tr[data-id="${currentLinkRowId}"]`) || tableBodyGor.rows[0]; 
                const links = Array.from(linkInputsContainer.querySelectorAll('.link-input-field'))
                                .map(input => input.value.trim())
                                .filter(link => link.length > 0);
                                
                // Update dataset di baris tabel
                row.dataset[currentLinkFieldName] = JSON.stringify(links);
                
                // Update tampilan tombol Kelola di baris (karena masih di mode edit)
                const linkCell = row.querySelector(`td.link-cell[data-field="${currentLinkFieldName}"]`);
                if (linkCell) {
                     const button = linkCell.querySelector('.manage-links-btn');
                     const buttonText = `Kelola (${links.length})`;
                     button.textContent = buttonText;
                     button.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-gray-400', 'hover:bg-gray-500');
                     button.classList.add(links.length > 0 ? 'bg-blue-600' : 'bg-gray-400');
                     button.classList.add(links.length > 0 ? 'hover:bg-blue-700' : 'hover:bg-gray-500');
                }
                
                // Jika ini adalah baris yang sudah ada di DB, simpan perubahannya
                if (currentLinkRowId) {
                     await saveBannerRowToFirebase(row, currentLinkRowId); // Tunggu sampai selesai
                }
                
                linkModal.style.display = 'none';
            });


            // Main Table Listeners
            tableBodyGor.addEventListener('click', async function(e) {
                const target = e.target;
                const row = target.closest('tr');
                if (!row) return;
                
                // Listener untuk tombol Link (Kelola)
                if (target.classList.contains('manage-links-btn') || target.closest('.manage-links-btn')) {
                    const button = target.closest('.manage-links-btn');
                    currentLinkFieldName = button.dataset.field;
                    currentLinkRowId = row.dataset.id || null; 
                    
                    const linksData = JSON.parse(row.dataset[currentLinkFieldName] || '[]');
                    const fieldTitle = LINK_FIELD_MAP[currentLinkFieldName].title;
                    
                    linkModalTitle.textContent = `Kelola Link: ${fieldTitle}`;
                    linkInputsContainer.innerHTML = ''; 
                    
                    if (linksData.length === 0) {
                        generateLinkInput(''); 
                    } else {
                        linksData.forEach(link => generateLinkInput(link));
                    }
                    
                    linkModal.style.display = 'block';
                    return;
                }
                
                // Logika Simpan/Hapus baris
                if (target.classList.contains('save-new-btn')) {
                    await saveBannerRowToFirebase(row); 
                } else if (target.classList.contains('delete-new-btn')) {
                    row.remove(); 
                    renumberRows();
                } 
                
                else if (target.classList.contains('delete-btn')) { 
                    rowToDeleteGor = row; 
                    confirmModalGor.style.display = 'block'; 
                }
                else if (target.classList.contains('extend-btn')) { 
                    rowToExtend = row; 
                    document.getElementById('extendCost').value = ''; 
                    document.getElementById('extendDuration').value = '1';
                    document.getElementById('extendUnit').value = 'Bulan';
                    extendModal.style.display = 'block'; 
                }
                else if (target.classList.contains('edit-btn')) {
                    const isEditing = target.textContent === 'Edit';
                    
                    if (!isEditing) { // Klik 'Simpan'
                        const docId = row.dataset.id;
                        await saveBannerRowToFirebase(row, docId); // Tunggu sampai tersimpan
                        
                        // Perbarui tampilan sel link secara manual untuk menampilkan select dropdown (mode view)
                        ['fotoVenueLinks', 'dataCustomerLinks', 'fotoBannerLinks'].forEach(fieldKey => {
                            const links = JSON.parse(row.dataset[fieldKey] || '[]');
                            const linkCell = row.querySelector(`td.link-cell[data-field="${fieldKey}"]`);
                            if (linkCell) {
                                // Ganti innerHTML cell dengan konten non-editable (dropdown)
                                // Hapus tag <td> dan </td> yang ditambahkan oleh createLinkButtonCell
                                linkCell.innerHTML = createLinkButtonCell(fieldKey, links, false).replace(/<td[^>]*>|<\/td>/g, '');
                            }
                        });

                        toggleRowInputs(row, false);
                        target.textContent = 'Edit';
                        target.classList.toggle('bg-yellow-400'); target.classList.toggle('hover:bg-yellow-500');
                        target.classList.toggle('bg-green-500'); target.classList.toggle('hover:bg-green-600');
                        row.querySelectorAll('.delete-btn, .extend-btn').forEach(btn => btn.style.display = 'inline-block');
                    } else { // Klik 'Edit'
                        // Perbarui tampilan sel link secara manual untuk menampilkan tombol Kelola (mode edit)
                        ['fotoVenueLinks', 'dataCustomerLinks', 'fotoBannerLinks'].forEach(fieldKey => {
                            const links = JSON.parse(row.dataset[fieldKey] || '[]');
                            const linkCell = row.querySelector(`td.link-cell[data-field="${fieldKey}"]`);
                            if (linkCell) {
                                // Ganti innerHTML cell dengan konten editable (tombol Kelola)
                                linkCell.innerHTML = createLinkButtonCell(fieldKey, links, true).replace(/<td[^>]*>|<\/td>/g, '');
                            }
                        });

                        toggleRowInputs(row, true);
                        target.textContent = 'Simpan';
                        target.classList.toggle('bg-yellow-400'); target.classList.toggle('hover:bg-yellow-500');
                        target.classList.toggle('bg-green-500'); target.classList.toggle('hover:bg-green-600');
                        row.querySelectorAll('.delete-btn, .extend-btn').forEach(btn => btn.style.display = 'none');
                    }
                }
                
            });
            
            searchGorInput.addEventListener('input', renderBannerTable);
        }
    </script>

</body>
</html>