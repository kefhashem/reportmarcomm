<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Content Report - Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .preview-img {
            max-width: 50px;
            max-height: 50px;
            border-radius: 6px;
            object-fit: cover;
        }
        /* Style for disabled dropdown */
        select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible-content.show {
            max-height: 1000px; /* Adjust as needed */
        }
         /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Login Section -->
    <div id="login-section" class="min-h-screen flex items-center justify-center bg-gray-900 text-white p-4">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-2xl shadow-lg border border-gray-700">
            <h1 class="text-3xl font-bold text-center mb-2">Marcomm Report</h1>
            <p class="text-center text-gray-400 mb-8">Please login to continue</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block mb-2 text-sm font-medium text-gray-300">Username</label>
                    <input type="text" id="username" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="admin" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" placeholder="•••••••••" required>
                </div>
                <button type="submit" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-3 text-center transition duration-300">Login</button>
                <p id="error-message" class="text-red-500 text-sm mt-4 text-center" style="display: none;">Incorrect username or password.</p>
            </form>
        </div>
    </div>

    <!-- Report Section -->
    <div id="report-section" class="hidden">
        <header class="bg-white shadow-md p-4 sticky top-0 z-20">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">Daily Content Report</h1>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Combined Sticky Wrapper for Form and Search -->
            <div class="sticky top-16 z-10 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-2">
                    <!-- Search Section -->
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-700">Search Report</h2>
                        <button id="toggle-form-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300 flex items-center justify-center gap-1 text-xs">
                            <svg id="toggle-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            <span id="toggle-text">Add Report</span>
                        </button>
                    </div>
                     <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                        <div>
                            <label for="search-tanggal-mulai" class="block mb-1 text-xs font-medium text-gray-700">From Date</label>
                            <input type="date" id="search-tanggal-mulai" class="p-2 border rounded-lg w-full text-xs">
                        </div>
                        <div>
                            <label for="search-tanggal-akhir" class="block mb-1 text-xs font-medium text-gray-700">To Date</label>
                            <input type="date" id="search-tanggal-akhir" class="p-2 border rounded-lg w-full text-xs">
                        </div>
                        <button id="reset-search" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Reset</button>
                    </div>

                    <!-- Collapsible Input Form -->
                    <div id="add-form-container" class="collapsible-content">
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <h2 class="text-sm font-semibold text-gray-700 mb-3">Report Input Form</h2>
                            <form id="add-report-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="col-span-1">
                                    <label for="report-tanggal" class="block mb-2 text-sm font-medium text-gray-900">Date</label>
                                    <input type="date" id="report-tanggal" class="p-2 border rounded-lg w-full" required>
                                </div>
                                <div class="col-span-1">
                                    <label for="report-nama" class="block mb-2 text-sm font-medium text-gray-900">Name</label>
                                    <select id="report-nama" class="p-2 border rounded-lg w-full" required>
                                        <option value="">Select Name</option>
                                        <option value="Abil">Abil</option>
                                        <option value="Totok">Totok</option>
                                        <option value="Webi">Webi</option>
                                    </select>
                                </div>
                                <div class="col-span-1">
                                    <label for="report-brand" class="block mb-2 text-sm font-medium text-gray-900">Brand</label>
                                     <select id="report-brand" class="p-2 border rounded-lg w-full" required>
                                        <option value="">Select Brand</option>
                                        <option value="wang un">wang un</option>
                                        <option value="kaosedhewe">kaosedhewe</option>
                                        <option value="shift up">shift up</option>
                                    </select>
                                </div>
                                <div id="input-container" class="col-span-1 md:col-span-2 lg:col-span-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div id="tiktok-field" class="hidden"><input type="text" id="report-tiktok" placeholder="Tiktok Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="instagram-field" class="hidden"><input type="text" id="report-instagram" placeholder="Instagram Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="mitra-ig-field" class="hidden"><input type="text" id="report-mitra-ig" placeholder="Mitra IG Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="gmb-field" class="hidden"><input type="text" id="report-gmb" placeholder="GMB Link or -" class="p-2 border rounded-lg w-full"></div>
                                    <div id="mitra-sa-field" class="hidden col-span-1 md:col-span-2 lg:col-span-3 flex items-center pt-4">
                                        <input id="report-mitra-sa" type="checkbox" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                        <label for="report-mitra-sa" class="ml-2 text-sm font-medium text-gray-900">Mitra (SA) Report Done</label>
                                    </div>
                                </div>
                                <div class="col-span-1 md:col-span-2 lg:col-span-3">
                                    <button type="submit" id="submit-report-btn" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">Save Report</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Report Table -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg overflow-hidden">
                     <div class="p-6">
                       <h2 class="text-xl font-semibold text-gray-700">Report Details</h2>
                       <p class="text-gray-500 mt-1">The data you input will appear here.</p>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                                <tr>
                                    <th scope="col" class="px-2 py-3">No.</th>
                                    <th scope="col" class="px-2 py-3">Date</th>
                                    <th scope="col" class="px-2 py-3">Name</th>
                                    <th scope="col" class="px-2 py-3">Brand</th>
                                    <th scope="col" class="px-2 py-3">Tiktok</th>
                                    <th scope="col" class="px-2 py-3">Instagram</th>
                                    <th scope="col" class="px-2 py-3">Mitra IG</th>
                                    <th scope="col" class="px-2 py-3">Mitra (SA)</th>
                                    <th scope="col" class="px-2 py-3">GMB</th>
                                    <th scope="col" class="px-2 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="report-body">
                                <!-- Data will be loaded from Firebase here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                         <h2 class="text-xl font-semibold text-gray-700 mb-4">Total Content</h2>
                         <div id="summary-section" class="space-y-3">
                            <div class="flex justify-between items-center text-gray-600"><span>Tiktok</span><span id="total-tiktok" class="font-bold text-gray-800 bg-blue-100 text-blue-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Instagram</span><span id="total-instagram" class="font-bold text-gray-800 bg-pink-100 text-pink-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Mitra IG</span><span id="total-mitra-ig" class="font-bold text-gray-800 bg-purple-100 text-purple-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>Mitra (SA)</span><span id="total-mitra-sa" class="font-bold text-gray-800 bg-green-100 text-green-800 px-3 py-1 rounded-full">0</span></div>
                            <div class="flex justify-between items-center text-gray-600"><span>GMB</span><span id="total-gmb" class="font-bold text-gray-800 bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full">0</span></div>
                         </div>
                         <div class="mt-4 pt-4 border-t"><p class="text-sm text-gray-500">Totals will update automatically.</p></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-30 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Delete Confirmation</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this report? This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Delete</button>
            </div>
        </div>
    </div>
    
     <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p id="loading-text" class="text-gray-700">Saving data...</p>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDgkGmmXLwESu2zODxX3eb5_Eu4aSK0HpQ",
            authDomain: "reportmarcomm-d1ef9.firebaseapp.com",
            projectId: "reportmarcomm-d1ef9",
            storageBucket: "reportmarcomm-d1ef9.appspot.com",
            messagingSenderId: "510927575797",
            appId: "1:510927575797:web:0397850bcbdcbb078003bc",
            measurementId: "G-W07G2HHF84"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Element References ---
        const loginSection = document.getElementById('login-section');
        const reportSection = document.getElementById('report-section');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const errorMessage = document.getElementById('error-message');
        const addReportForm = document.getElementById('add-report-form');
        const reportBody = document.getElementById('report-body');
        const namaSelect = document.getElementById('report-nama');
        const brandSelect = document.getElementById('report-brand');
        const searchTanggalMulai = document.getElementById('search-tanggal-mulai');
        const searchTanggalAkhir = document.getElementById('search-tanggal-akhir');
        const resetSearchButton = document.getElementById('reset-search');
        const toggleFormButton = document.getElementById('toggle-form-button');
        const addFormContainer = document.getElementById('add-form-container');
        const toggleText = document.getElementById('toggle-text');
        const toggleIcon = document.getElementById('toggle-icon');
        const deleteModal = document.getElementById('delete-modal');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let rowToDelete = null;
        let reportsDataCache = []; // Cache to store data from Firebase

        const fields = {
            tiktok: document.getElementById('tiktok-field'),
            instagram: document.getElementById('instagram-field'),
            mitraIg: document.getElementById('mitra-ig-field'),
            mitraSa: document.getElementById('mitra-sa-field'),
            gmb: document.getElementById('gmb-field')
        };

        // --- Login Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'admin' && password === 'marcomm') {
                loginSection.classList.add('hidden');
                reportSection.classList.remove('hidden');
                errorMessage.style.display = 'none';
                document.getElementById('report-tanggal').valueAsDate = new Date();
                loadReports(); // Load data after login
            } else {
                errorMessage.style.display = 'block';
            }
        });

        // --- Logout Logic ---
        logoutButton.addEventListener('click', () => {
            reportSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        // --- Toggle Add Form Logic ---
        toggleFormButton.addEventListener('click', () => {
            const isShown = addFormContainer.classList.toggle('show');
            if (isShown) {
                toggleText.textContent = 'Close Form';
                toggleIcon.style.transform = 'rotate(45deg)';
            } else {
                toggleText.textContent = 'Add Report';
                toggleIcon.style.transform = 'rotate(0deg)';
            }
        });
        
        // --- Dynamic Form Logic ---
        namaSelect.addEventListener('change', () => {
            const selectedName = namaSelect.value;
            Object.values(fields).forEach(field => field.classList.add('hidden'));
            brandSelect.disabled = false;
            switch(selectedName) {
                case 'Abil':
                    brandSelect.value = 'wang un';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.mitraIg.classList.remove('hidden');
                    break;
                case 'Totok':
                    brandSelect.value = 'kaosedhewe';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.mitraSa.classList.remove('hidden');
                    break;
                case 'Webi':
                    brandSelect.value = 'shift up';
                    brandSelect.disabled = true;
                    fields.tiktok.classList.remove('hidden');
                    fields.instagram.classList.remove('hidden');
                    fields.gmb.classList.remove('hidden');
                    break;
                default:
                    brandSelect.value = '';
                    brandSelect.disabled = false;
                    break;
            }
        });

        // --- Add Report Logic ---
        addReportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingText.textContent = "Saving data...";
            loadingModal.classList.remove('hidden');

            try {
                const reportData = {
                    tanggal: document.getElementById('report-tanggal').value,
                    nama: namaSelect.value,
                    brand: brandSelect.value,
                    tiktok: document.getElementById('report-tiktok').value,
                    instagram: document.getElementById('report-instagram').value,
                    mitraIg: document.getElementById('report-mitra-ig').value,
                    gmb: document.getElementById('report-gmb').value,
                    mitraSaDone: document.getElementById('report-mitra-sa').checked,
                    createdAt: new Date()
                };

                if (!reportData.tanggal || !reportData.nama || !reportData.brand) {
                    alert('Please complete Date, Name, and Brand.');
                    return;
                }
                
                await addDoc(collection(db, "reports"), reportData);
                addReportForm.reset();
                namaSelect.dispatchEvent(new Event('change'));
                document.getElementById('report-tanggal').valueAsDate = new Date();
            } catch (error) {
                console.error("Error during report submission: ", error);
                alert("Failed to save report. Please check your connection and try again.");
            } finally {
                loadingModal.classList.add('hidden');
            }
        });
        
        // --- Load Reports from Firebase ---
        function loadReports() {
            const q = query(collection(db, "reports"), orderBy("tanggal", "desc"));
            onSnapshot(q, (querySnapshot) => {
                reportsDataCache = [];
                querySnapshot.forEach((doc) => {
                    reportsDataCache.push({ id: doc.id, ...doc.data() });
                });
                renderTable(); // Initial render
            });
        }

        // --- Render Table from Cache ---
        function renderTable() {
            const startDate = searchTanggalMulai.value;
            const endDate = searchTanggalAkhir.value;
            
            const filteredData = reportsDataCache.filter(report => {
                const rowDate = report.tanggal;
                const isAfterStart = startDate ? rowDate >= startDate : true;
                const isBeforeEnd = endDate ? rowDate <= endDate : true;
                return isAfterStart && isBeforeEnd;
            });

            reportBody.innerHTML = '';
            filteredData.forEach((report, index) => {
                const newRow = document.createElement('tr');
                newRow.className = 'bg-white border-b hover:bg-gray-50';
                newRow.dataset.id = report.id;

                const mitraSaContent = report.mitraSaDone 
                    ? `<svg class="w-5 h-5 text-green-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                    : '-';
                
                newRow.innerHTML = `
                    <td class="px-2 py-4">${index + 1}</td>
                    <td class="px-2 py-4">${report.tanggal}</td>
                    <td class="px-2 py-4 font-medium text-gray-900">${report.nama}</td>
                    <td class="px-2 py-4">${report.brand}</td>
                    <td class="px-2 py-4">${(report.tiktok && report.tiktok.trim() !== '-') ? `<a href="${report.tiktok}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">${(report.instagram && report.instagram.trim() !== '-') ? `<a href="${report.instagram}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">${(report.mitraIg && report.mitraIg.trim() !== '-') ? `<a href="${report.mitraIg}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4 text-center">${mitraSaContent}</td>
                    <td class="px-2 py-4">${(report.gmb && report.gmb.trim() !== '-') ? `<a href="${report.gmb}" target="_blank" class="text-blue-600 hover:underline">View</a>` : '-'}</td>
                    <td class="px-2 py-4">
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded-md">Delete</button>
                    </td>
                `;
                reportBody.appendChild(newRow);
            });
            updateTotals();
        }

        // --- Delete Report Logic ---
        reportBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                rowToDelete = e.target.closest('tr'); // Store the row to be deleted
                deleteModal.classList.remove('hidden'); // Show the confirmation modal
            }
        });

        // --- Modal Button Logic ---
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            rowToDelete = null;
        });

        confirmDeleteBtn.addEventListener('click', async () => {
            if (rowToDelete) {
                loadingText.textContent = "Deleting data...";
                loadingModal.classList.remove('hidden');
                const docId = rowToDelete.dataset.id;
                
                try {
                    await deleteDoc(doc(db, "reports", docId));
                } catch(error) {
                    console.error("Error removing document: ", error);
                    alert("Failed to delete report.");
                } finally {
                    rowToDelete = null;
                    deleteModal.classList.add('hidden');
                    loadingModal.classList.add('hidden');
                }
            }
        });

        // --- Search/Filter Logic ---
        searchTanggalMulai.addEventListener('input', renderTable);
        searchTanggalAkhir.addEventListener('input', renderTable);
        resetSearchButton.addEventListener('click', () => {
            searchTanggalMulai.value = '';
            searchTanggalAkhir.value = '';
            renderTable();
        });

        // --- Update Totals Logic ---
        function updateTotals() {
            const rows = reportBody.getElementsByTagName('tr');
            let counts = { tiktok: 0, instagram: 0, mitraIg: 0, mitraSa: 0, gmb: 0 };
            for (let row of rows) {
                const cells = row.cells;
                if (cells[4].querySelector('a')) counts.tiktok++;
                if (cells[5].querySelector('a')) counts.instagram++;
                if (cells[6].querySelector('a')) counts.mitraIg++;
                if (cells[7].querySelector('svg')) counts.mitraSa++;
                if (cells[8].querySelector('a')) counts.gmb++;
            }
            document.getElementById('total-tiktok').textContent = counts.tiktok;
            document.getElementById('total-instagram').textContent = counts.instagram;
            document.getElementById('total-mitra-ig').textContent = counts.mitraIg;
            document.getElementById('total-mitra-sa').textContent = counts.mitraSa;
            document.getElementById('total-gmb').textContent = counts.gmb;
        }
    </script>

</body>
</html>

