<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Laporan Marcomm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .table-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-green:hover { background-color: #059669; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover { background-color: #dc2626; }
        h1, h2 { font-weight: 700; }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        #promo-update-body tr { counter-increment: promo-counter; }
        #promo-update-body tr td:first-child::before { content: counter(promo-counter); }
        #banner-report-body tr { counter-increment: banner-counter; }
        #banner-report-body tr td:first-child::before { content: counter(banner-counter); }
       
        @media print {
            body { background-color: white; }
            .no-print { display: none; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; page-break-inside: avoid; }
            .chart-container { page-break-inside: avoid; }
            .banner-photo-preview { max-height: 150px; }
        }
    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-sm">
            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAAhdEVYdENyZWF0aW9uIFRpbWUAMjAyNC0wMS0wNlQwNTowMzozMyswMDowMClD8+EAAEAASURBVHgB7N1BBgENDDAA9/8KbQcI1EVhYBERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERER... (rest of a very long base64 string)" alt="Logo Kaosedhewe" class="h-20 w-auto mx-auto mb-8">
            <div class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                <h1 class="text-center text-2xl font-bold text-gray-800 mb-6">Login Laporan Marcomm</h1>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">
                        Username
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="username" type="text" placeholder="Username">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                        Password
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="password" type="password" placeholder="******************">
                </div>
                <p id="login-error" class="text-red-500 text-xs italic mb-4 hidden">ID atau Password salah!</p>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" id="login-btn" type="button">
                        Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Screen (Initially hidden) -->
    <div id="dashboard-screen" class="p-4 sm:p-6 md:p-8" style="display: none;">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="card flex items-center gap-4 sm:gap-6">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAAhdEVYdENyZWF0aW9uIFRpbWUAMjAyNC0wMS0wNlQwNTowMzozMyswMDowMClD8+EAAEAASURBVHgB7N1BBgENDDAA9/8KbQcI1EVhYBERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERER... (rest of a very long base64 string)" alt="Logo Kaosedhewe" class="h-14 w-auto sm:h-16">
                <div class="text-left">
                     <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Laporan Marcomm</h1>
                     <p class="text-gray-500 mt-1 text-sm sm:text-base">Laporan Kinerja Konten untuk Shift Up, Kaosedhewe, & Wang Un</p>
                </div>
            </div>

            <!-- Riwayat & Filter Laporan -->
            <div class="card no-print">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Filter & Riwayat Laporan</h2>
                
                <!-- Filter Section -->
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Gabungkan Laporan berdasarkan Tanggal</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="filter-start-date" class="block text-sm font-medium text-gray-600">Dari Tanggal</label>
                            <input type="date" id="filter-start-date" class="table-input mt-1">
                        </div>
                        <div>
                            <label for="filter-end-date" class="block text-sm font-medium text-gray-600">Sampai Tanggal</label>
                            <input type="date" id="filter-end-date" class="table-input mt-1">
                        </div>
                        <button id="preview-combined-report" class="btn btn-primary w-full sm:w-auto">Preview Laporan Gabungan</button>
                    </div>
                </div>

                <!-- History List -->
                <div id="report-history-container">
                    <p class="text-gray-500 text-sm">Belum ada riwayat laporan yang tersimpan.</p>
                </div>
                <button id="clear-form-btn" class="btn btn-secondary mt-6">Buat Laporan Baru (Kosongkan Form)</button>
            </div>

            <div id="report-form-content">
                <div id="report-content-wrapper">
                    <!-- Periode Laporan -->
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Periode Laporan</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="start-date" class="block text-sm font-medium text-gray-600">Tanggal Mulai</label>
                                <input type="date" id="start-date" class="table-input mt-1">
                            </div>
                            <div>
                                <label for="end-date" class="block text-sm font-medium text-gray-600">Tanggal Selesai</label>
                                <input type="date" id="end-date" class="table-input mt-1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- All other cards from the dashboard go here... -->
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Update Konten Harian (IG & TikTok)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Konten</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Catatan</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="daily-content-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                        <button id="add-daily-content" class="btn btn-primary mt-4 no-print">Tambah Baris Konten</button>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Produksi Konten (Mitra IG & Mitra SA)</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mitra</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Tugas</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="mitra-content-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                        <button id="add-mitra-content" class="btn btn-primary mt-4 no-print">Tambah Baris Produksi</button>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Update Platform Lain (YTS, GMB)</h2>
                         <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi Update</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="other-platform-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                        <button id="add-other-platform" class="btn btn-primary mt-4 no-print">Tambah Baris Update</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Update Promo</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Promo</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Klaim</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Terpakai</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="promo-update-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                            </div>
                            <button id="add-promo-update" class="btn btn-primary mt-4 no-print">Tambah Baris Promo</button>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Report Pemasangan Banner</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Gor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sudah Visit</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proses</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Foto Bukti</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="banner-report-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <button id="add-banner-report" class="btn btn-primary mt-4 no-print">Tambah Baris Banner</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Riset Kompetitor</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Objek</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Kompetitor & Link</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hasil Riset</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="competitor-research-body"></tbody></table>
                            </div>
                            <button id="add-competitor-research" class="btn btn-primary mt-4 no-print">Tambah Baris Riset</button>
                        </div>
                        <div class="card">
                            <h2 class="text-xl font-semibold text-gray-700 mb-4">Riset Event</h2>
                             <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Event</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Link Banner</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider no-print">Aksi</th></tr></thead><tbody id="event-research-body"></tbody></table>
                            </div>
                            <button id="add-event-research" class="btn btn-primary mt-4 no-print">Tambah Baris Event</button>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Update Followers</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Platform</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Followers Awal</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Followers Akhir</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pertumbuhan</th></tr></thead><tbody id="follower-update-body" class="bg-white divide-y divide-gray-200"></tbody></table>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Analisis Visual & Chart</h2>
                        <div class="text-center mb-6">
                            <button id="generate-charts" class="btn btn-secondary w-full md:w-auto no-print">Buat / Perbarui Chart</button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4 chart-container"><div><h3 class="text-lg font-semibold text-gray-700 mb-2 text-center">Chart Pertumbuhan Followers</h3><canvas id="followerGrowthChart"></canvas></div><div><h3 class="text-lg font-semibold text-gray-700 mb-2 text-center">Chart Jumlah Konten per Platform</h3><canvas id="contentVolumeChart"></canvas></div></div>
                    </div>
                    <div class="card">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4">Analisis & Kesimpulan Tertulis</h2>
                        <textarea id="analysis" rows="8" class="table-input" placeholder="Tuliskan analisa performa berdasarkan data dan chart di atas..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Tombol Aksi Utama -->
            <div class="card text-center no-print">
                <div class="flex flex-wrap justify-center gap-4">
                    <button id="save-report-btn" class="btn btn-primary">Simpan Laporan Saat Ini</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden no-print z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Hapus Laporan</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Apakah Anda yakin ingin menghapus laporan ini? Tindakan ini tidak dapat diurungkan.</p>
                </div>
                <div class="items-center px-4 py-3 gap-2 flex justify-center">
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">Ya, Hapus</button>
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Batal</button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FUNGSI BARU UNTUK KOMPRESI GAMBAR ---
        function compressImage(file, quality = 0.7, maxWidth = 800) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
                reader.onerror = error => reject(error);
            });
        }

        let db, auth, userId, appId;
        let allReports = [];

        // --- STORAGE ABSTRACTION ---
        const storage = {
            mode: 'Offline',
            listen: (callback) => {},
            save: async (reportData, id) => {},
            delete: async (id) => {},
            getById: (id) => {}
        };

        // --- FIREBASE IMPLEMENTATION ---
        async function initializeFirebase() {
            try {
                if (typeof __firebase_config === 'undefined' || typeof __app_id === 'undefined') {
                    throw new Error("Firebase config not found.");
                }
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = __app_id;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        Object.assign(storage, firebaseProvider);
                        storage.listen(reports => {
                            allReports = reports;
                            renderHistory(allReports);
                        });
                    }
                });
            } catch(e) {
                console.warn("Firebase initialization failed.", e.message);
                Object.assign(storage, offlineProvider);
                alert("Aplikasi ini berjalan dalam mode OFFLINE.\n\nRiwayat laporan tidak akan tersimpan antar perangkat. Untuk mengaktifkan penyimpanan online, jalankan aplikasi ini di lingkungan yang didukung.");
                document.getElementById('save-report-btn').disabled = true;
                document.getElementById('save-report-btn').textContent = "Simpan (Mode Offline)";
            }
        }
        
        const firebaseProvider = {
            mode: 'Online (Data tersimpan di Cloud)',
            listen: (callback) => {
                const reportsCollectionPath = `artifacts/${appId}/users/${userId}/marcomm_reports`;
                onSnapshot(collection(db, reportsCollectionPath), (snapshot) => {
                    const reports = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    reports.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    callback(reports);
                });
            },
            save: async (reportData, id) => {
                const reportsCollectionPath = `artifacts/${appId}/users/${userId}/marcomm_reports`;
                try {
                    if(id){
                        await setDoc(doc(db, reportsCollectionPath, id), reportData);
                    } else {
                        await addDoc(collection(db, reportsCollectionPath), reportData);
                    }
                    return true;
                } catch(e) {
                    console.error("Firebase save error:", e);
                    return false;
                }
            },
            delete: async (id) => {
                 const reportsCollectionPath = `artifacts/${appId}/users/${userId}/marcomm_reports`;
                await deleteDoc(doc(db, reportsCollectionPath, id));
            },
            getById: (id) => allReports.find(r => r.id == id)
        };
        
        const offlineProvider = {
            mode: 'Offline (Penyimpanan Dinonaktifkan)',
            listen: (callback) => { callback([]); },
            save: async () => { 
                alert("Tidak bisa menyimpan dalam mode offline.");
                return false; 
            },
            delete: async () => { alert("Tidak bisa menghapus dalam mode offline."); },
            getById: () => null
        };

        
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- LOGIN LOGIC ---
            const loginScreen = document.getElementById('login-screen');
            const dashboardScreen = document.getElementById('dashboard-screen');
            const loginBtn = document.getElementById('login-btn');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('login-error');

            function handleLogin() {
                if (usernameInput.value.trim() === 'admin' && passwordInput.value === 'marcomm') {
                    loginScreen.style.display = 'none';
                    dashboardScreen.style.display = 'block';
                    initializeFirebase();
                } else {
                    loginError.classList.remove('hidden');
                    passwordInput.value = '';
                }
            }
            loginBtn.addEventListener('click', handleLogin);
            passwordInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });

            // --- DASHBOARD & MODAL LOGIC ---
            let followerChartInstance = null;
            let contentChartInstance = null;
            const deleteModal = document.getElementById('delete-modal');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            let reportIdToDelete = null;

            function showDeleteModal(id) {
                reportIdToDelete = id;
                deleteModal.classList.remove('hidden');
            }
            function hideDeleteModal() {
                reportIdToDelete = null;
                deleteModal.classList.add('hidden');
            }
            confirmDeleteBtn.addEventListener('click', () => {
                if (reportIdToDelete) deleteReport(reportIdToDelete);
                hideDeleteModal();
            });
            cancelDeleteBtn.addEventListener('click', hideDeleteModal);
            
            // --- HELPER FUNCTIONS ---
            const createRow = (tbody, content) => {
                const newRow = tbody.insertRow();
                newRow.innerHTML = content;
                return newRow;
            };
            const getTableData = tbodyId => Array.from(document.querySelectorAll(`#${tbodyId} tr`)).map(row => Array.from(row.querySelectorAll('input:not([type="file"]), select, textarea')).map(input => input.value));
            const getBannerReportData = () => Array.from(document.querySelectorAll('#banner-report-body tr')).map(row => {
                const imgSrc = row.querySelector('.banner-photo-preview').src;
                return [
                    row.querySelector('input[type="text"]').value,
                    row.querySelector('input[type="date"]').value,
                    row.querySelector('select').value,
                    imgSrc.startsWith('data:image') ? imgSrc : ''
                ];
            });
            
            // --- POPULATE FORM FUNCTIONS ---
            const populateTable = (tbody, data, rowTemplateFunc) => {
                tbody.innerHTML = '';
                const items = data && data.length > 0 ? data : [[]];
                items.forEach(rowData => {
                    const row = createRow(tbody, rowTemplateFunc(rowData));
                    row.querySelectorAll('input:not([type="file"]), select, textarea').forEach((input, index) => {
                        if (rowData[index] !== undefined) input.value = rowData[index];
                    });
                });
            };

            const populateBannerReportTable = (tbody, data) => {
                tbody.innerHTML = '';
                const items = data && data.length > 0 ? data : [[]];
                items.forEach(rowData => {
                    const row = createRow(tbody, bannerReportRowTpl(rowData));
                    row.querySelector('input[type="text"]').value = rowData[0] || '';
                    row.querySelector('input[type="date"]').value = rowData[1] || '';
                    row.querySelector('select').value = rowData[2] || 'Belum';
                    const img = row.querySelector('.banner-photo-preview');
                    if (rowData[3]) {
                        img.src = rowData[3];
                        img.classList.remove('hidden');
                    }
                });
            };
            
            // --- ROW TEMPLATES ---
            const deleteBtnHtml = `<td class="px-4 py-2 no-print"><button type="button" class="btn btn-sm btn-red delete-row-btn">Hapus</button></td>`;
            
            const dailyContentRowTpl = (d=[]) => `
                <td class="px-4 py-2"><input type="date" class="table-input" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><select class="table-input brand-selector"><option>Shift Up</option><option>Kaosedhewe</option><option>Wang Un</option></select></td>
                <td class="px-4 py-2"><select class="table-input platform-selector"><option>Instagram</option><option>TikTok</option></select></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="https://..." value="${d[3] || ''}"></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Catatan singkat..." value="${d[4] || ''}"></td>
                ${deleteBtnHtml}`;
            const mitraContentRowTpl = (d=[]) => `
                <td class="px-4 py-2"><input type="date" class="table-input" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><select class="table-input"><option>Mitra IG</option><option>Mitra SA</option></select></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Brief konten..." value="${d[2] || ''}"></td>
                <td class="px-4 py-2"><select class="table-input"><option>Done</option><option>On Progress</option><option>Revisi</option></select></td>
                ${deleteBtnHtml}`;
            const otherPlatformRowTpl = (d=[]) => `
                <td class="px-4 py-2"><input type="date" class="table-input" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><select class="table-input"><option>YTS</option><option>GMB</option></select></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Update promo di GMB..." value="${d[2] || ''}"></td>
                ${deleteBtnHtml}`;
            const promoUpdateRowTpl = (d=[]) => `
                <td class="px-4 py-2 font-semibold"></td>
                <td class="px-4 py-2"><select class="table-input"><option>KD 10 (FOLLOW & COMMENT)</option><option>KD 15 (FOLLOW LIKE COMMENT & SHARE)</option><option>KD 20 (GMB)</option><option>6 Free 1 (CUSTOMER LOYAL)</option><option>Offline Undian</option></select></td>
                <td class="px-4 py-2"><input type="number" class="table-input" placeholder="0" value="${d[1] || ''}"></td>
                <td class="px-4 py-2"><input type="number" class="table-input" placeholder="0" value="${d[2] || ''}"></td>
                ${deleteBtnHtml}`;
            const bannerReportRowTpl = (d = []) => `
                <td class="px-4 py-2 font-semibold"></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Nama GOR/Lokasi" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><input type="date" class="table-input" value="${d[1] || ''}"></td>
                <td class="px-4 py-2"><select class="table-input"><option>Belum</option><option>Proses Pemasangan</option><option>Sudah Terpasang</option></select></td>
                <td class="px-4 py-2">
                    <input type="file" class="banner-photo-upload no-print text-xs" accept="image/*">
                    <img src="${d[3] || ''}" class="banner-photo-preview h-20 w-auto mt-2 rounded ${d[3] ? '' : 'hidden'}">
                </td>
                ${deleteBtnHtml}`;
            const competitorResearchRowTpl = (d=[]) => `
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Konten Video" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Nama & Link" value="${d[1] || ''}"></td>
                <td class="px-4 py-2"><textarea rows="2" class="table-input" placeholder="Menggunakan sound viral...">${d[2] || ''}</textarea></td>
                ${deleteBtnHtml}`;
            const eventResearchRowTpl = (d=[]) => `
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Harbolnas 10.10" value="${d[0] || ''}"></td>
                <td class="px-4 py-2"><input type="date" class="table-input" value="${d[1] || ''}"></td>
                <td class="px-4 py-2"><input type="text" class="table-input" placeholder="Link banner/poster..." value="${d[2] || ''}"></td>
                ${deleteBtnHtml}`;
            
            // --- FORM ACTIONS ---
            const clearForm = () => {
                document.getElementById('report-form-content').reset();
                document.querySelectorAll('tbody').forEach(tbody => {
                    if (tbody.id) {
                         const templateFunc = window[tbody.id.replace(/-/g,'_') + '_tpl'];
                         if(templateFunc) populateTable(tbody, [], templateFunc);
                    }
                });
                populateBannerReportTable(document.getElementById('banner-report-body'), []);
                
                document.querySelectorAll('#follower-update-body .growth-cell').forEach(cell => {
                    cell.textContent = '0';
                    cell.classList.remove('text-green-600', 'text-red-600');
                });
                if (followerChartInstance) followerChartInstance.destroy();
                if (contentChartInstance) contentChartInstance.destroy();
                alert('Form telah dikosongkan.');
            };
            
            document.getElementById('add-daily-content').addEventListener('click', () => createRow(document.getElementById('daily-content-body'), dailyContentRowTpl()));
            document.getElementById('add-mitra-content').addEventListener('click', () => createRow(document.getElementById('mitra-content-body'), mitraContentRowTpl()));
            document.getElementById('add-other-platform').addEventListener('click', () => createRow(document.getElementById('other-platform-body'), otherPlatformRowTpl()));
            document.getElementById('add-promo-update').addEventListener('click', () => createRow(document.getElementById('promo-update-body'), promoUpdateRowTpl()));
            document.getElementById('add-banner-report').addEventListener('click', () => createRow(document.getElementById('banner-report-body'), bannerReportRowTpl()));
            document.getElementById('add-competitor-research').addEventListener('click', () => createRow(document.getElementById('competitor-research-body'), competitorResearchRowTpl()));
            document.getElementById('add-event-research').addEventListener('click', () => createRow(document.getElementById('event-research-body'), eventResearchRowTpl()));
            
            document.getElementById('report-form-content').addEventListener('click', e => {
                if (e.target.classList.contains('delete-row-btn')) {
                    const row = e.target.closest('tr');
                    if(row.parentElement.rows.length > 1) {
                        row.remove();
                    } else {
                        alert('Setidaknya harus ada satu baris.');
                    }
                }
            });

            document.getElementById('banner-report-body').addEventListener('change', async e => {
                if (e.target.classList.contains('banner-photo-upload') && e.target.files[0]) {
                    const imgPreview = e.target.nextElementSibling;
                    try {
                        imgPreview.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
                        imgPreview.classList.remove('hidden');
                        const compressedDataUrl = await compressImage(e.target.files[0]);
                        imgPreview.src = compressedDataUrl;
                    } catch (error) {
                        alert("Gagal memproses gambar.");
                        imgPreview.classList.add('hidden');
                    }
                }
            });

            // --- FOLLOWER TABLE LOGIC ---
            const followerTbody = document.getElementById('follower-update-body');
            followerTbody.addEventListener('input', e => {
                if (e.target.classList.contains('follower-start') || e.target.classList.contains('follower-end')) {
                    const row = e.target.closest('tr');
                    const start = parseInt(row.querySelector('.follower-start').value) || 0;
                    const end = parseInt(row.querySelector('.follower-end').value) || 0;
                    const growthCell = row.querySelector('.growth-cell');
                    const growth = end - start;
                    growthCell.textContent = growth >= 0 ? `+${growth}` : growth;
                    growthCell.classList.toggle('text-green-600', growth > 0);
                    growthCell.classList.toggle('text-red-600', growth < 0);
                }
            });

            // --- HISTORY & DATABASE LOGIC ---
            const renderHistory = (reports) => {
                const container = document.getElementById('report-history-container');
                container.innerHTML = reports.length === 0 ? '<p class="text-gray-500 text-sm">Belum ada riwayat laporan yang tersimpan.</p>' : '';
                reports.forEach(report => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <span class="font-medium text-gray-800">${report.title}</span>
                        <div class="flex flex-wrap gap-2 justify-end">
                            <button data-id="${report.id}" class="btn btn-sm btn-secondary preview-btn">Preview</button>
                            <button data-id="${report.id}" class="btn btn-sm btn-primary edit-btn">Edit</button>
                            <button data-id="${report.id}" class="btn btn-sm btn-red delete-confirm-btn">Hapus</button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            };
            
            const saveCurrentReport = async () => {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) return alert('Silakan isi Tanggal Mulai dan Tanggal Selesai.');
                
                const reportData = {
                    startDate, endDate, title: `Laporan ${startDate} s/d ${endDate}`,
                    dailyContent: getTableData('daily-content-body'),
                    mitraContent: getTableData('mitra-content-body'),
                    otherPlatform: getTableData('other-platform-body'),
                    promoUpdate: getTableData('promo-update-body'),
                    bannerReport: getBannerReportData(),
                    competitorResearch: getTableData('competitor-research-body'),
                    eventResearch: getTableData('event-research-body'),
                    followers: getTableData('follower-update-body'),
                    analysis: document.getElementById('analysis').value,
                    createdAt: new Date().toISOString()
                };
                
                const success = await storage.save(reportData);
                if (success) {
                    alert(`Laporan "${reportData.title}" berhasil disimpan!`);
                    storage.listen(reports => { allReports = reports; renderHistory(reports); });
                }
            };

            const loadReportForEditing = (id) => {
                const report = storage.getById(id);
                if (!report) return;
                
                document.getElementById('start-date').value = report.startDate;
                document.getElementById('end-date').value = report.endDate;
                document.getElementById('analysis').value = report.analysis;
                
                populateTable(document.getElementById('daily-content-body'), report.dailyContent, dailyContentRowTpl);
                populateTable(document.getElementById('mitra-content-body'), report.mitraContent, mitraContentRowTpl);
                populateTable(document.getElementById('other-platform-body'), report.otherPlatform, otherPlatformRowTpl);
                populateTable(document.getElementById('promo-update-body'), report.promoUpdate, promoUpdateRowTpl);
                populateBannerReportTable(document.getElementById('banner-report-body'), report.bannerReport);
                populateTable(document.getElementById('competitor-research-body'), report.competitorResearch, competitorResearchRowTpl);
                populateTable(document.getElementById('event-research-body'), report.eventResearch, eventResearchRowTpl);
                
                const followerRows = document.querySelectorAll('#follower-update-body tr');
                if (report.followers && report.followers.length > 0) {
                    followerRows.forEach((row, index) => {
                        const startInput = row.querySelector('.follower-start');
                        startInput.value = report.followers[index][0] || 0;
                        row.querySelector('.follower-end').value = report.followers[index][1] || 0;
                        startInput.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                }
                alert(`Laporan "${report.title}" telah dimuat untuk diedit.`);
                window.scrollTo(0, 0);
            };

            const deleteReport = async (id) => {
                await storage.delete(id);
                alert('Laporan berhasil dihapus.');
                storage.listen(reports => { allReports = reports; renderHistory(reports); });
            };

            async function showPreview(reportId, combinedReportData = null) {
                const report = combinedReportData || storage.getById(reportId);
                if (!report) return;

                const chartImages = await generateChartsForPreview(report);
                
                let previewHtml = '';
                const createStaticTable = (title, headers, data, rowMapper) => {
                    let tableHtml = `<div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">${title}</h2><div class="overflow-x-auto"><table class="min-w-full"><thead><tr>`;
                    headers.forEach(h => tableHtml += `<th>${h}</th>`);
                    tableHtml += `</tr></thead><tbody>`;
                    if (data && data.length > 0 && (data[0] && data[0].length > 0)) {
                        data.forEach((rowData, i) => tableHtml += rowMapper(rowData, i));
                    } else {
                        tableHtml += `<tr><td colspan="${headers.length}" class="text-gray-500 italic py-4 text-center">Tidak ada data</td></tr>`;
                    }
                    tableHtml += `</tbody></table></div></div>`;
                    return tableHtml;
                };
                
                previewHtml += `<div class="card flex items-center gap-4 sm:gap-6"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAYAAACAvzbMAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAJcEhZcwAAFiUAABYlAUlSJPAAAAAhdEVYdENyZWF0aW9uIFRpbWUAMjAyNC0wMS0wNlQwNTowMzozMyswMDowMClD8+EAAEAASURBVHgB7N1BBgENDDAA9/8KbQcI1EVhYBERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERERER... (rest of a very long base64 string)" alt="Logo Kaosedhewe" class="h-14 w-auto sm:h-16"><div class="text-left"><h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Laporan Marcomm</h1></div></div>`;
                previewHtml += `<div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Periode Laporan</h2><p><strong>Tanggal Mulai:</strong> ${report.startDate}</p><p><strong>Tanggal Selesai:</strong> ${report.endDate}</p></div>`;
                
                previewHtml += createStaticTable('Update Konten Harian', ['Tanggal', 'Brand', 'Platform', 'Link', 'Catatan'], report.dailyContent, r => `<tr><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td><td>${r[3]||'-'}</td><td>${r[4]||'-'}</td></tr>`);
                previewHtml += createStaticTable('Produksi Konten', ['Tanggal', 'Mitra', 'Deskripsi', 'Status'], report.mitraContent, r => `<tr><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td><td>${r[3]||'-'}</td></tr>`);
                previewHtml += createStaticTable('Update Platform Lain', ['Tanggal', 'Platform', 'Update'], report.otherPlatform, r => `<tr><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td></tr>`);
                
                let promoHtml = createStaticTable('Update Promo', ['No.', 'Promo', 'Klaim', 'Terpakai'], report.promoUpdate, (r,i) => `<tr><td>${i+1}</td><td>${r[0]||'-'}</td><td>${r[1]||'0'}</td><td>${r[2]||'0'}</td></tr>`);
                let bannerHtml = createStaticTable('Report Pemasangan Banner', ['No.', 'Nama GOR', 'Visit', 'Proses', 'Foto'], report.bannerReport, (r,i) => `<tr><td>${i+1}</td><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td><td>${r[3] ? `<img src="${r[3]}" class="banner-photo-preview">` : '(Tidak ada foto)'}</td></tr>`);
                previewHtml += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${promoHtml.replace('<div class="card">','').replace('</div></div>','</div>')} ${bannerHtml.replace('<div class="card">','').replace('</div></div>','</div>')}</div>`;

                let compHtml = createStaticTable('Riset Kompetitor', ['Objek', 'Kompetitor', 'Hasil'], report.competitorResearch, r => `<tr><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td></tr>`);
                let eventHtml = createStaticTable('Riset Event', ['Event', 'Tanggal', 'Banner'], report.eventResearch, r => `<tr><td>${r[0]||'-'}</td><td>${r[1]||'-'}</td><td>${r[2]||'-'}</td></tr>`);
                previewHtml += `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${compHtml.replace('<div class="card">','').replace('</div></div>','</div>')} ${eventHtml.replace('<div class="card">','').replace('</div></div>','</div>')}</div>`;

                const followerHeaders = ['Brand', 'Platform', 'Awal', 'Akhir', 'Pertumbuhan'];
                previewHtml += createStaticTable('Update Followers', followerHeaders, report.followers, (r, i) => {
                     const brands = ['Shift Up', 'Kaosedhewe', 'Wang Un']; const platforms = ['Instagram', 'TikTok'];
                     const brand = brands[Math.floor(i/2)]; const platform = platforms[i%2];
                     const start = parseInt(r[0]||0); const end = parseInt(r[1]||0); const growth = end-start;
                     return `<tr><td>${brand}</td><td>${platform}</td><td>${start}</td><td>${end}</td><td style="color:${growth >= 0 ? '#059669':'#dc2626'}">${growth >= 0 ? '+'+growth:growth}</td></tr>`
                });
                
                previewHtml += `<div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Analisis Visual & Chart</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-4"><div class="text-center"><h3 class="font-semibold mb-2">Pertumbuhan Followers</h3><img src="${chartImages.followerChart}" class="w-full h-auto border rounded"></div><div class="text-center"><h3 class="font-semibold mb-2">Jumlah Konten</h3><img src="${chartImages.contentChart}" class="w-full h-auto border rounded"></div></div></div>`;
                previewHtml += `<div class="card"><h2 class="text-xl font-semibold text-gray-700 mb-4">Analisis & Kesimpulan</h2><div class="preview-textarea-text">${report.analysis || 'Tidak ada analisis.'}</div></div>`;

                const newPageTemplate = `<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><title>Preview: ${report.title}</title><script src="https://cdn.tailwindcss.com"><\/script><script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"><\/script><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><style>body{font-family:'Inter',sans-serif;background-color:#f3f4f6;padding:2rem}.card{background-color:white;border-radius:.75rem;padding:1.5rem;margin-bottom:2rem;box-shadow:0 4px 6px -1px #0000001a,0 2px 4px -2px #0000001a}h1,h2{font-weight:700}th{text-align:left;padding:.75rem;background-color:#f9fafb;border-bottom:1px solid #e5e7eb}td{text-align:left;padding:.75rem;border-bottom:1px solid #e5e7eb}.preview-textarea-text{white-space:pre-wrap;padding:.5rem;border:1px solid #e5e7eb;border-radius:.375rem;min-height:4rem}.banner-photo-preview{max-height:150px;border-radius:.5rem;margin-top:.5rem}.btn{padding:.5rem 1rem;border-radius:.375rem;font-weight:500;cursor:pointer;transition:background-color .2s}.btn-green{background-color:#10b981;color:white}.btn-secondary{background-color:#6b7280;color:white}@media print{body{padding:0;background-color:white}.no-print{display:none}.card{box-shadow:none;border:1px solid #e5e7eb;page-break-inside:avoid;margin-bottom:1.5rem}}</style></head><body><div class="max-w-4xl mx-auto"><div class="card no-print text-center"><h1 class="text-2xl font-bold mb-4">Preview Laporan</h1><div class="flex justify-center gap-4"><button onclick="window.print()" class="btn btn-green">Cetak</button><button id="pdfBtn" class="btn btn-secondary">Export PDF</button></div></div><div id="report-content-to-print">${previewHtml}</div></div><script>document.getElementById('pdfBtn').addEventListener('click',()=>{const e=document.getElementById('report-content-to-print');html2pdf().from(e).set({margin:[.5,.5,.5,.5],filename:'Laporan Marcomm - ${report.startDate} sd ${report.endDate}.pdf',image:{type:'jpeg',quality:.98},html2canvas:{scale:2,useCORS:!0,logging:!1},jsPDF:{unit:'in',format:'a4',orientation:'portrait'}}).save()})<\/script></body></html>`;

                const previewTab = window.open('', '_blank');
                previewTab.document.write(newPageTemplate);
                previewTab.document.close();
            }

            // --- EVENT LISTENERS ---
            document.getElementById('report-history-container').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const reportId = target.dataset.id;
                
                if (target.classList.contains('preview-btn')) showPreview(reportId);
                if (target.classList.contains('edit-btn')) loadReportForEditing(reportId);
                if (target.classList.contains('delete-confirm-btn')) showDeleteModal(reportId);
            });
            
            document.getElementById('preview-combined-report').addEventListener('click', async () => {
                const startDate = document.getElementById('filter-start-date').value;
                const endDate = document.getElementById('filter-end-date').value;
                if (!startDate || !endDate) {
                    return alert('Silakan pilih rentang tanggal filter terlebih dahulu.');
                }

                const filteredReports = allReports.filter(report => {
                    return report.startDate >= startDate && report.endDate <= endDate;
                });

                if (filteredReports.length === 0) {
                    return alert('Tidak ada laporan yang ditemukan dalam rentang tanggal tersebut.');
                }

                // Combine data from filtered reports
                const combinedData = {
                    id: 'combined',
                    title: `Laporan Gabungan ${startDate} s/d ${endDate}`,
                    startDate: startDate, endDate: endDate,
                    dailyContent: [], mitraContent: [], otherPlatform: [],
                    promoUpdate: [], bannerReport: [], competitorResearch: [],
                    eventResearch: [], followers: [], analysis: ''
                };

                let lastFollowers = {};
                let totalAnalysis = [];

                filteredReports.reverse().forEach(report => { // reverse to process from oldest to newest
                    combinedData.dailyContent.push(...report.dailyContent);
                    combinedData.mitraContent.push(...report.mitraContent);
                    combinedData.otherPlatform.push(...report.otherPlatform);
                    combinedData.promoUpdate.push(...report.promoUpdate);
                    combinedData.bannerReport.push(...report.bannerReport);
                    combinedData.competitorResearch.push(...report.competitorResearch);
                    combinedData.eventResearch.push(...report.eventResearch);
                    
                    if (report.analysis) {
                        totalAnalysis.push(`Analisis dari ${report.startDate} s/d ${report.endDate}:\n${report.analysis}`);
                    }

                    if (report.followers && report.followers.length > 0) {
                        report.followers.forEach((followerData, i) => {
                            if (!lastFollowers[i]) {
                                lastFollowers[i] = { start: parseInt(followerData[0]) || 0, end: parseInt(followerData[1]) || 0 };
                            } else {
                                lastFollowers[i].end = parseInt(followerData[1]) || 0;
                            }
                        });
                    }
                });

                combinedData.followers = Object.values(lastFollowers).map(f => [f.start.toString(), f.end.toString()]);
                combinedData.analysis = totalAnalysis.join('\n\n---\n\n');

                showPreview(null, combinedData);
            });

            document.getElementById('save-report-btn').addEventListener('click', saveCurrentReport);
            document.getElementById('clear-form-btn').addEventListener('click', clearForm);
            
            document.getElementById('generate-charts').addEventListener('click', () => generateCharts());

            function generateCharts(containerElement = document) {
                if (followerChartInstance) followerChartInstance.destroy();
                if (contentChartInstance) contentChartInstance.destroy();
                
                const followerCtx = document.getElementById('followerGrowthChart').getContext('2d');
                let followerLabels = [], followerData = [];
                document.querySelectorAll('#follower-update-body tr').forEach(row => {
                    const growthText = row.querySelector('.growth-cell').textContent.replace('+', '');
                    followerLabels.push(`${row.cells[0].textContent} - ${row.cells[1].textContent}`);
                    followerData.push(parseInt(growthText) || 0);
                });
                followerChartInstance = new Chart(followerCtx, { type: 'bar', data: { labels: followerLabels, datasets: [{ label: 'Pertumbuhan Followers', data: followerData, backgroundColor: followerData.map(v => v >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'), borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true } } } });

                const contentCtx = document.getElementById('contentVolumeChart').getContext('2d');
                let contentCounts = {};
                document.querySelectorAll('#daily-content-body tr').forEach(row => {
                    const brandEl = row.querySelector('.brand-selector');
                    const platformEl = row.querySelector('.platform-selector');
                    if (brandEl && platformEl && brandEl.value) {
                         const key = `${brandEl.value} - ${platformEl.value}`;
                         contentCounts[key] = (contentCounts[key] || 0) + 1;
                    }
                });
                contentChartInstance = new Chart(contentCtx, { type: 'bar', data: { labels: Object.keys(contentCounts), datasets: [{ label: 'Jumlah Konten Dibuat', data: Object.values(contentCounts), backgroundColor: 'rgba(54, 162, 255, 0.6)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            }

            async function generateChartsForPreview(reportData) {
                const followerCanvas = document.createElement('canvas');
                const contentCanvas = document.createElement('canvas');
                
                let followerLabels = [], followerData = [];
                if (reportData.followers) {
                    reportData.followers.forEach((r, i) => {
                        const brands = ['Shift Up', 'Kaosedhewe', 'Wang Un']; const platforms = ['Instagram', 'TikTok'];
                        const brand = brands[Math.floor(i/2)]; const platform = platforms[i%2];
                        const start = parseInt(r[0]||0); const end = parseInt(r[1]||0); const growth = end-start;
                        followerLabels.push(`${brand} - ${platform}`);
                        followerData.push(growth);
                    });
                }
                
                let contentCounts = {};
                if (reportData.dailyContent) {
                    reportData.dailyContent.forEach(r => {
                        if (r[1] && r[2]) {
                            const key = `${r[1]} - ${r[2]}`;
                            contentCounts[key] = (contentCounts[key] || 0) + 1;
                        }
                    });
                }

                const followerChart = new Chart(followerCanvas.getContext('2d'), { type: 'bar', data: { labels: followerLabels, datasets: [{ label: 'Pertumbuhan Followers', data: followerData, backgroundColor: followerData.map(v => v >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'), borderWidth: 1 }] }, options: { responsive: false, animation: false, scales: { y: { beginAtZero: true } } } });
                const contentChart = new Chart(contentCanvas.getContext('2d'), { type: 'bar', data: { labels: Object.keys(contentCounts), datasets: [{ label: 'Jumlah Konten Dibuat', data: Object.values(contentCounts), backgroundColor: 'rgba(54, 162, 255, 0.6)', borderWidth: 1 }] }, options: { responsive: false, animation: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });

                await new Promise(resolve => setTimeout(resolve, 500)); 

                return {
                    followerChart: followerChart.toBase64Image(),
                    contentChart: contentChart.toBase64Image()
                };
            }

            // --- INITIALIZATION ---
            createRow(document.getElementById('daily-content-body'), dailyContentRowTpl());
            createRow(document.getElementById('mitra-content-body'), mitraContentRowTpl());
            createRow(document.getElementById('other-platform-body'), otherPlatformRowTpl());
            createRow(document.getElementById('promo-update-body'), promoUpdateRowTpl());
            createRow(document.getElementById('banner-report-body'), bannerReportRowTpl());
            createRow(document.getElementById('competitor-research-body'), competitorResearchRowTpl());
            createRow(document.getElementById('event-research-body'), eventResearchRowTpl());

            const brands = ['Shift Up', 'Kaosedhewe', 'Wang Un'];
            const platforms = ['Instagram', 'TikTok'];
            followerTbody.innerHTML = '';
            brands.forEach(brand => {
                platforms.forEach(platform => {
                    createRow(followerTbody, `
                        <td class="px-4 py-2 font-medium text-gray-900">${brand}</td>
                        <td class="px-4 py-2 text-gray-600">${platform}</td>
                        <td class="px-4 py-2"><input type="number" class="table-input follower-start" placeholder="0"></td>
                        <td class="px-4 py-2"><input type="number" class="table-input follower-end" placeholder="0"></td>
                        <td class="px-4 py-2 font-semibold growth-cell">0</td>
                    `);
                });
            });
            window.daily_content_body_tpl = dailyContentRowTpl;
            window.mitra_content_body_tpl = mitraContentRowTpl;
            window.other_platform_body_tpl = otherPlatformRowTpl;
            window.promo_update_body_tpl = promoUpdateRowTpl;
            window.banner_report_body_tpl = bannerReportRowTpl;
            window.competitor_research_body_tpl = competitorResearchRowTpl;
            window.event_research_body_tpl = eventResearchRowTpl;
        });

    </script>
</body>
</html>

